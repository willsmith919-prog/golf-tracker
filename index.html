<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>LiveLinks - Real-time Golf Scoring</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  
  <style>
    body { margin: 0; padding: 0; overflow-x: hidden; }
    input, textarea { font-size: 16px !important; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyB8u4N8yPT9VJejYCgfT_v_FSGohCghr1M",
      authDomain: "livelinks-cf018.firebaseapp.com",
      databaseURL: "https://livelinks-cf018-default-rtdb.firebaseio.com",
      projectId: "livelinks-cf018",
      storageBucket: "livelinks-cf018.firebasestorage.app",
      messagingSenderId: "658641708649",
      appId: "1:658641708649:web:620bd1327d75c3678424f8"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const database = firebase.database();
    const auth = firebase.auth();

    // Generate or retrieve device ID
    const getDeviceId = () => {
      let deviceId = localStorage.getItem('deviceId');
      if (!deviceId) {
        deviceId = 'device-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('deviceId', deviceId);
      }
      return deviceId;
    };

    // Generate short event code
    const generateEventCode = async (courseId) => {
      const coursePrefix = courseId.split('-')[0].toUpperCase().substring(0, 4);
      const randomPart = Math.random().toString(36).substring(2, 6).toUpperCase();
      const code = `${coursePrefix}-${randomPart}`;
      
      const snapshot = await database.ref('eventCodes').child(code).once('value');
      if (snapshot.exists()) {
        return generateEventCode(courseId);
      }
      
      return code;
    };

    // Icons
    const Plus = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>);
    const Users = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>);
    const Calendar = () => (<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>);
    const Trash = () => (<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>);
    const Trophy = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg>);
    const Link = () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>);
    const BarChart = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>);
    const ClipboardList = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>);
    const Copy = () => (<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>);
    const ChevronDown = () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="6 9 12 15 18 9"></polyline></svg>);
    const ChevronUp = () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="18 15 12 9 6 15"></polyline></svg>);
    const RotateCcw = () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>);
    const Edit = () => (<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>);

    function LiveLinks() {
      // Admin check
      const isAdmin = () => {
        return currentUser && currentUser.email === 'willsmith919@gmail.com';
      };

      // State declarations
      const [view, setView] = useState('login');
      const [currentUser, setCurrentUser] = useState(null);
      const [userProfile, setUserProfile] = useState(null);
      const [authLoading, setAuthLoading] = useState(true);
      const [courses, setCourses] = useState([]);
      const [globalCourses, setGlobalCourses] = useState([]);
      const [managingCourses, setManagingCourses] = useState(false);
      const [editingCourse, setEditingCourse] = useState(null);
      const [courseForm, setCourseForm] = useState({
        name: '',
        location: '',
        strokeIndex: Array(18).fill(''),
        tees: [{
          id: 'tee-1',
          name: '',
          rating: '',
          slope: '',
          pars: Array(18).fill(''),
          yardages: Array(18).fill('')
        }]
      });
      const [eventValidationMessages, setEventValidationMessages] = useState({});
      
      // Event creation state
      const [newEvent, setNewEvent] = useState({
        name: '',
        courseId: '',
        date: new Date().toISOString().split('T')[0],
        time: '',
        format: 'scramble',
        startingHole: 1,
        teams: []
      });
      const [selectedBaseCourse, setSelectedBaseCourse] = useState('');
      const [newTeam, setNewTeam] = useState({ name: '', player1: '', player2: '' });
      
      // Current event/team state
      const [joinCode, setJoinCode] = useState('');
      const [currentEvent, setCurrentEvent] = useState(null);
      const [selectedTeam, setSelectedTeam] = useState(null);
      
      // UI state
      const [feedback, setFeedback] = useState('');
      const [scoreConfirmation, setScoreConfirmation] = useState(null);
      const [expandedTeams, setExpandedTeams] = useState([]);
      const [editingHole, setEditingHole] = useState(null);
      const [playerScores, setPlayerScores] = useState(null);
      const [viewingTeamScorecard, setViewingTeamScorecard] = useState(null);
      
      // Auth state
      const [loginEmail, setLoginEmail] = useState('');
      const [loginPassword, setLoginPassword] = useState('');
      const [signupEmail, setSignupEmail] = useState('');
      const [signupPassword, setSignupPassword] = useState('');
      const [signupDisplayName, setSignupDisplayName] = useState('');
      const [signupHandicap, setSignupHandicap] = useState('');
      const [authError, setAuthError] = useState('');
      const [authLoading2, setAuthLoading2] = useState(false);
      
      // League state
      const [userLeagues, setUserLeagues] = useState([]);
      const [currentLeague, setCurrentLeague] = useState(null);
      const [newLeague, setNewLeague] = useState({
        name: '',
        description: '',
        seasonName: '2026 Season',
        pointSystem: { 1: 20, 2: 16, 3: 13, 4: 10, 5: 8 }
      });
      const [leagueCode, setLeagueCode] = useState('');
      const [creatingEventForLeague, setCreatingEventForLeague] = useState(null);
      const [editingEvent, setEditingEvent] = useState(null);
      const [editForm, setEditForm] = useState(null);
      const [leagueEvents, setLeagueEvents] = useState([]);
      const [eventRegistrations, setEventRegistrations] = useState({});
      const [editingTeamName, setEditingTeamName] = useState(null);
      const [tempTeamName, setTempTeamName] = useState('');
      
      // Refs
      const eventListenerRef = useRef(null);
      const undoTimerRef = useRef(null);
      const deviceId = getDeviceId();

      // Format helpers
      const formatNames = {
        scramble: "2-Man Scramble",
        shamble: "2-Man Shamble",
        bestball: "2-Man Best Ball",
        stableford: "Individual Stableford"
      };

      const formatDescriptions = {
        scramble: "Both players hit, pick the best shot, both play from there. One team score per hole.",
        shamble: "Both players hit, pick the best drive, then each plays their own ball. Best individual score counts.",
        bestball: "Each player plays their own ball. Lower score of the two counts for the team.",
        stableford: "Individual scoring. Points awarded based on score vs par. Highest points wins."
      };

      const calculateStablefordPoints = (score, par) => {
        const diff = score - par;
        if (diff >= 2) return 0;
        if (diff === 1) return 1;
        if (diff === 0) return 2;
        if (diff === -1) return 3;
        if (diff === -2) return 4;
        if (diff <= -3) return 5;
        return 0;
      };

      // League helper functions
      const generateLeagueCode = async () => {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ';
        const nums = '0123456789';
        
        let code;
        let exists = true;
        
        while (exists) {
          const letters = Array(3).fill(0).map(() => chars[Math.floor(Math.random() * chars.length)]).join('');
          const numbers = Array(4).fill(0).map(() => nums[Math.floor(Math.random() * nums.length)]).join('');
          code = `${letters}-${numbers}`;
          
          const snapshot = await database.ref(`leagueCodes/${code}`).once('value');
          exists = snapshot.exists();
        }
        
        return code;
      };

      const loadUserLeagues = async (userId) => {
        try {
          const userSnapshot = await database.ref(`users/${userId}/leagues`).once('value');
          const userLeagues = userSnapshot.val() || {};
          
          const leaguesData = [];
          for (const leagueId of Object.keys(userLeagues)) {
            const leagueSnapshot = await database.ref(`leagues/${leagueId}`).once('value');
            const league = leagueSnapshot.val();
            if (league) {
              leaguesData.push({ id: leagueId, ...league, userRole: userLeagues[leagueId].role });
            }
          }
          
          return leaguesData;
        } catch (error) {
          console.error('Error loading leagues:', error);
          return [];
        }
      };

      // Initialize courses and cleanup
      useEffect(() => { loadCourses(); }, []);

      useEffect(() => {
        return () => {
          if (eventListenerRef.current) {
            eventListenerRef.current.off();
          }
          if (undoTimerRef.current) {
            clearTimeout(undoTimerRef.current);
          }
        };
      }, []);

      const loadCourses = async () => {
        try {
          const coursesSnapshot = await database.ref('courses').once('value');
          const coursesData = coursesSnapshot.val() || {};
          const coursesArray = Object.entries(coursesData).map(([id, data]) => ({
            id,
            ...data
          })).sort((a, b) => a.name.localeCompare(b.name));
          
          setGlobalCourses(coursesArray);
          
          // Build courses array for event creation (flattened course+tee combinations)
          const eventCourses = [];
          coursesArray.forEach(course => {
            Object.entries(course.tees || {}).forEach(([teeId, tee]) => {
              eventCourses.push({
                id: `${course.id}-${teeId}`,
                courseId: course.id,
                teeId: teeId,
                name: course.name,
                location: course.location,
                teeName: tee.name,
                holes: tee.pars, // backwards compat
                pars: tee.pars,
                yardages: tee.yardages,
                strokeIndex: course.strokeIndex,
                rating: tee.rating,
                slope: tee.slope
              });
            });
          });
          
          setCourses(eventCourses);
        } catch (error) {
          console.error('Error loading courses:', error);
        }
      };

      // Populate edit form when editingEvent changes
      useEffect(() => {
        if (editingEvent && view === 'edit-event') {
          setEditForm({
            name: editingEvent.meta.name,
            courseId: editingEvent.meta.courseId,
            date: editingEvent.meta.date,
            time: editingEvent.meta.time || '',
            format: editingEvent.meta.format,
            startingHole: Object.values(editingEvent.teams || {})[0]?.currentHole || 1,
            teams: Object.entries(editingEvent.teams || {}).map(([teamKey, team]) => ({
              key: teamKey,
              name: team.name,
              playerIds: team.playerIds || [],
              players: team.players || []
            }))
          });
        } else {
          setEditForm(null);
        }
      }, [editingEvent, view]);

      // Load league events when viewing dashboard
      useEffect(() => {
        const loadLeagueEvents = async () => {
          if (view !== 'league-dashboard' || !currentLeague) {
            setLeagueEvents([]);
            return;
          }

          const activeSeason = Object.values(currentLeague.seasons || {}).find(s => s.status === 'active');
          
          if (!activeSeason || !activeSeason.events) {
            setLeagueEvents([]);
            return;
          }

          try {
            const eventsData = [];
            for (const eventId of activeSeason.events) {
              const snapshot = await database.ref(`events/${eventId}`).once('value');
              const event = snapshot.val();
              if (event) {
                eventsData.push({ id: eventId, ...event });
              }
            }
            eventsData.sort((a, b) => new Date(a.meta.date) - new Date(b.meta.date));
            setLeagueEvents(eventsData);

            // Set up real-time listeners
            activeSeason.events.forEach(eventId => {
              database.ref(`events/${eventId}`).on('value', (snapshot) => {
                const updatedEvent = snapshot.val();
                if (updatedEvent) {
                  setLeagueEvents(prev => {
                    const updated = prev.map(e => 
                      e.id === eventId ? { id: eventId, ...updatedEvent } : e
                    );
                    return updated.sort((a, b) => new Date(a.meta.date) - new Date(b.meta.date));
                  });
                }
              });
            });
          } catch (error) {
            console.error('Error loading league events:', error);
          }
        };

        loadLeagueEvents();

        return () => {
          if (view === 'league-dashboard' && currentLeague) {
            const activeSeason = Object.values(currentLeague.seasons || {}).find(s => s.status === 'active');
            if (activeSeason?.events) {
              activeSeason.events.forEach(eventId => {
                database.ref(`events/${eventId}`).off();
              });
            }
          }
        };
      }, [view, currentLeague]);

      // Load event registrations when viewing event details or editing
      useEffect(() => {
        const loadRegistrations = async () => {
          if ((view === 'event-details' || view === 'edit-event') && editingEvent) {
            // Set up real-time listener for registrations
            const regsRef = database.ref(`events/${editingEvent.id}/registrations`);
            regsRef.on('value', (snapshot) => {
              setEventRegistrations(snapshot.val() || {});
            });

            return () => {
              regsRef.off();
            };
          } else {
            setEventRegistrations({});
          }
        };
        
        const cleanup = loadRegistrations();
        return () => {
          if (cleanup && typeof cleanup.then === 'function') {
            cleanup.then(fn => fn && fn());
          }
        };
      }, [view, editingEvent]);

      // Auth state listener
      useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged(async (user) => {
          setCurrentUser(user);
          
          if (user) {
            try {
              const profileSnapshot = await database.ref(`users/${user.uid}`).once('value');
              const profile = profileSnapshot.val();
              setUserProfile(profile);
              
              const leagues = await loadUserLeagues(user.uid);
              setUserLeagues(leagues);
              
              if (view === 'login' || view === 'signup') {
                setView('home');
              }
            } catch (error) {
              console.error('Error fetching user profile:', error);
            }
          } else {
            setUserProfile(null);
            setUserLeagues([]);
            setView('login');
          }
          
          setAuthLoading(false);
        });

        return () => unsubscribe();
      }, []);

      const addTeam = () => {
        if (newEvent.format === 'stableford') {
          if (!newTeam.name) {
            setFeedback('Please enter player name');
            setTimeout(() => setFeedback(''), 2000);
            return;
          }
          setNewEvent({
            ...newEvent,
            teams: [...newEvent.teams, { name: newTeam.name, player1: newTeam.name, id: Date.now() }]
          });
          setNewTeam({ name: '', player1: '', player2: '' });
        } else {
          if (!newTeam.name || !newTeam.player1 || !newTeam.player2) {
            setFeedback('Please fill in all team fields');
            setTimeout(() => setFeedback(''), 2000);
            return;
          }
          setNewEvent({
            ...newEvent,
            teams: [...newEvent.teams, { ...newTeam, id: Date.now() }]
          });
          setNewTeam({ name: '', player1: '', player2: '' });
        }
      };

      const removeTeam = (teamId) => {
        setNewEvent({
          ...newEvent,
          teams: newEvent.teams.filter(t => t.id !== teamId)
        });
      };

      const createEvent = async () => {
        const minPlayers = creatingEventForLeague ? 0 : (newEvent.format === 'stableford' ? 1 : 2);
        
        if (!newEvent.name || !newEvent.courseId || newEvent.teams.length < minPlayers) {
          const teamWord = newEvent.format === 'stableford' ? 'player' : 'teams';
          const teamMsg = minPlayers === 0 ? '' : ` and at least ${minPlayers} ${teamWord}`;
          setFeedback(`Please add event name, course${teamMsg}`);
          setTimeout(() => setFeedback(''), 3000);
          return;
        }

        try {
          const course = courses.find(c => c.id === newEvent.courseId);
          const eventId = 'event-' + Date.now();
          const eventCode = await generateEventCode(course.id);
          
          const eventData = {
            meta: {
              name: newEvent.name,
              courseId: course.id,
              courseName: course.name,
              coursePars: course.holes,
              format: newEvent.format,
              date: newEvent.date,
              time: newEvent.time || null,
              createdBy: currentUser?.uid || deviceId,
              status: creatingEventForLeague ? "draft" : "active",
              leagueId: creatingEventForLeague?.leagueId || null,
              seasonId: creatingEventForLeague?.seasonId || null,
              createdAt: Date.now(),
              eventCode: eventCode
            },
            teams: {},
            registrations: {}
          };

          // Initialize teams with proper structure
          newEvent.teams.forEach((team, index) => {
            const scores = {};
            for (let i = 0; i < 18; i++) {
              scores[i] = -1;
            }
            
            eventData.teams[`team${index + 1}`] = {
              name: team.name,
              players: newEvent.format === 'stableford' ? [team.player1] : [team.player1, team.player2],
              playerIds: [], // Empty for manually created teams
              scores: scores,
              currentHole: newEvent.startingHole
            };
          });

          await database.ref(`events/${eventId}`).set(eventData);
          await database.ref(`eventCodes/${eventCode}`).set(eventId);
          
          if (creatingEventForLeague) {
            const { leagueId, seasonId } = creatingEventForLeague;
            const eventsRef = database.ref(`leagues/${leagueId}/seasons/${seasonId}/events`);
            const eventsSnapshot = await eventsRef.once('value');
            const events = eventsSnapshot.val() || [];
            
            const eventsArray = Array.isArray(events) ? events : [];
            eventsArray.push(eventId);
            
            await eventsRef.set(eventsArray);
          }
          
          setFeedback(`Event created! ${creatingEventForLeague ? 'Status: Draft' : `Code: ${eventCode}`}`);
          
          setTimeout(async () => {
            if (creatingEventForLeague) {
              const leagueSnapshot = await database.ref(`leagues/${creatingEventForLeague.leagueId}`).once('value');
              const updatedLeague = leagueSnapshot.val();
              
              if (updatedLeague) {
                setCurrentLeague({ 
                  id: creatingEventForLeague.leagueId, 
                  ...updatedLeague, 
                  userRole: currentLeague.userRole 
                });
              }
              setCreatingEventForLeague(null);
              setView('league-dashboard');
            } else {
              setCurrentEvent({ id: eventId, ...eventData });
              setView('event-lobby');
            }
            setFeedback('');
            setNewEvent({
              name: '',
              courseId: '',
              date: new Date().toISOString().split('T')[0],
              time: '',
              format: 'scramble',
              startingHole: 1,
              teams: []
            });
          }, 2000);

        } catch (error) {
          console.error('Error creating event:', error);
          setFeedback('Error creating event. Please try again.');
          setTimeout(() => setFeedback(''), 3000);
        }
      };

      // REGISTRATION HANDLERS
      const registerForEvent = async (eventId) => {
        if (!currentUser || !userProfile) return;
        
        try {
          await database.ref(`events/${eventId}/registrations/${currentUser.uid}`).set({
            displayName: userProfile.displayName,
            handicap: userProfile.handicap || null,
            registeredAt: Date.now(),
            status: 'registered'
          });
          
          setFeedback(`You're registered for this event!`);
          setTimeout(() => setFeedback(''), 2000);
        } catch (error) {
          console.error('Error registering:', error);
          setFeedback('Error registering for event');
        }
      };

      const withdrawFromEvent = async (eventId) => {
        if (!currentUser) return;
        
        try {
          await database.ref(`events/${eventId}/registrations/${currentUser.uid}/status`).set('withdrawn');
          
          setFeedback(`You've withdrawn from this event`);
          setTimeout(() => setFeedback(''), 2000);
        } catch (error) {
          console.error('Error withdrawing:', error);
          setFeedback('Error withdrawing from event');
        }
      };

      const addPlayerToEvent = async (eventId, userId, userDisplayName, userHandicap) => {
        try {
          await database.ref(`events/${eventId}/registrations/${userId}`).set({
            displayName: userDisplayName,
            handicap: userHandicap || null,
            registeredAt: Date.now(),
            status: 'registered',
            addedBy: 'commissioner'
          });
          
          setFeedback('Player added');
          setTimeout(() => setFeedback(''), 2000);
        } catch (error) {
          console.error('Error adding player:', error);
          setFeedback('Error adding player');
        }
      };

      const removePlayerFromEvent = async (eventId, userId) => {
        try {
          await database.ref(`events/${eventId}/registrations/${userId}/status`).set('withdrawn');
          
          setFeedback('Player removed');
          setTimeout(() => setFeedback(''), 2000);
        } catch (error) {
          console.error('Error removing player:', error);
          setFeedback('Error removing player');
        }
      };

      const assignPlayerToTeam = async (eventId, teamKey, userId, userName) => {
        try {
          const teamRef = database.ref(`events/${eventId}/teams/${teamKey}`);
          const teamSnapshot = await teamRef.once('value');
          const team = teamSnapshot.val() || { name: '', players: [], playerIds: [], scores: {}, currentHole: 1 };
          
          const updatedPlayerIds = [...(team.playerIds || []), userId];
          const updatedPlayers = [...(team.players || []), userName];
          
          let teamName = team.name;
          if (updatedPlayers.length <= 2) {
            teamName = updatedPlayers.join(' & ');
          }
          
          await teamRef.update({
            playerIds: updatedPlayerIds,
            players: updatedPlayers,
            name: teamName
          });
          
          setFeedback('Player assigned to team');
          setTimeout(() => setFeedback(''), 2000);
          
          const eventSnapshot = await database.ref(`events/${eventId}`).once('value');
          const updatedEvent = eventSnapshot.val();
          if (updatedEvent) {
            setEditingEvent({ id: eventId, ...updatedEvent });
          }
        } catch (error) {
          console.error('Error assigning player:', error);
          setFeedback('Error assigning player');
        }
      };

      const removePlayerFromTeam = async (eventId, teamKey, userId) => {
        try {
          const teamRef = database.ref(`events/${eventId}/teams/${teamKey}`);
          const teamSnapshot = await teamRef.once('value');
          const team = teamSnapshot.val();
          
          if (team) {
            const updatedPlayerIds = (team.playerIds || []).filter(id => id !== userId);
            const updatedPlayers = team.players.filter((_, idx) => team.playerIds[idx] !== userId);
            
            let teamName = team.name;
            if (updatedPlayers.length <= 2 && updatedPlayers.length > 0) {
              teamName = updatedPlayers.join(' & ');
            }
            
            if (updatedPlayerIds.length === 0) {
              await teamRef.remove();
            } else {
              await teamRef.update({
                playerIds: updatedPlayerIds,
                players: updatedPlayers,
                name: teamName
              });
            }
          }
          
          setFeedback('Player removed from team');
          setTimeout(() => setFeedback(''), 2000);
          
          const eventSnapshot = await database.ref(`events/${eventId}`).once('value');
          const updatedEvent = eventSnapshot.val();
          if (updatedEvent) {
            setEditingEvent({ id: eventId, ...updatedEvent });
          }
        } catch (error) {
          console.error('Error removing player from team:', error);
          setFeedback('Error removing player from team');
        }
      };

      const createNewTeam = async (eventId) => {
        try {
          const eventRef = database.ref(`events/${eventId}/teams`);
          const teamsSnapshot = await eventRef.once('value');
          const teams = teamsSnapshot.val() || {};
          
          let teamNum = 1;
          while (teams[`team${teamNum}`]) {
            teamNum++;
          }
          
          const newTeamKey = `team${teamNum}`;
          await eventRef.child(newTeamKey).set({
            name: `Team ${teamNum}`,
            players: [],
            playerIds: [],
            scores: {},
            currentHole: 1
          });
          
          setFeedback('Team created');
          setTimeout(() => setFeedback(''), 2000);
          
          const eventSnapshot = await database.ref(`events/${eventId}`).once('value');
          const updatedEvent = eventSnapshot.val();
          if (updatedEvent) {
            setEditingEvent({ id: eventId, ...updatedEvent });
          }
        } catch (error) {
          console.error('Error creating team:', error);
          setFeedback('Error creating team');
        }
      };

      const updateTeamName = async (eventId, teamKey, newName) => {
        try {
          await database.ref(`events/${eventId}/teams/${teamKey}/name`).set(newName);
          
          const eventSnapshot = await database.ref(`events/${eventId}`).once('value');
          const updatedEvent = eventSnapshot.val();
          if (updatedEvent) {
            setEditingEvent({ id: eventId, ...updatedEvent });
          }
          
          setEditingTeamName(null);
          setTempTeamName('');
        } catch (error) {
          console.error('Error updating team name:', error);
          setFeedback('Error updating team name');
        }
      };

      const joinEvent = async () => {
        if (!joinCode.trim()) {
          setFeedback('Please enter an event code');
          setTimeout(() => setFeedback(''), 2000);
          return;
        }

        try {
          let eventId = joinCode.trim();
          
          if (!eventId.startsWith('event-')) {
            const codeSnapshot = await database.ref(`eventCodes/${eventId}`).once('value');
            const realId = codeSnapshot.val();
            
            if (!realId) {
              setFeedback('Event not found. Check your code.');
              setTimeout(() => setFeedback(''), 3000);
              return;
            }
            
            eventId = realId;
          }
          
          const snapshot = await database.ref(`events/${eventId}`).once('value');
          const eventData = snapshot.val();
          
          if (!eventData) {
            setFeedback('Event not found. Check your code.');
            setTimeout(() => setFeedback(''), 3000);
            return;
          }

          setCurrentEvent({ id: eventId, ...eventData });
          setView('event-lobby');
          setJoinCode('');
        } catch (error) {
          console.error('Error joining event:', error);
          setFeedback('Error joining event. Please try again.');
          setTimeout(() => setFeedback(''), 3000);
        }
      };

      const startRealtimeSync = (eventId) => {
        if (eventListenerRef.current) {
          eventListenerRef.current.off();
        }

        const eventRef = database.ref(`events/${eventId}`);
        eventListenerRef.current = eventRef;

        return new Promise((resolve) => {
          eventRef.once('value', (snapshot) => {
            const eventData = snapshot.val();
            if (eventData) {
              setCurrentEvent({ id: eventId, ...eventData });
              resolve(eventData);
            }
          });

          eventRef.on('value', (snapshot) => {
            const eventData = snapshot.val();
            if (eventData) {
              setCurrentEvent({ id: eventId, ...eventData });
            }
          });
        });
      };

      const selectTeam = async (teamId) => {
        setSelectedTeam(teamId);
        const eventData = await startRealtimeSync(currentEvent.id);
        setView('scoring');
      };

      const submitScore = async (score, holeOverride = null, playerUsed = null, player1Score = null, player2Score = null, drivePlayer = null) => {
        try {
          if (!currentEvent || !currentEvent.teams || !selectedTeam) {
            console.error('Missing event or team data');
            return;
          }

          const team = currentEvent.teams[selectedTeam];
          
          if (!team || !team.scores) {
            console.error('Team or scores array not found');
            return;
          }

          const holeNum = holeOverride !== null ? holeOverride : team.currentHole;
          const holeIndex = holeNum - 1;
          
          const previousScore = team.scores[holeIndex];
          const previousHole = team.currentHole;
          
          await database.ref(`events/${currentEvent.id}/teams/${selectedTeam}/scores/${holeIndex}`).set(score);
          
          if (playerUsed) {
            await database.ref(`events/${currentEvent.id}/teams/${selectedTeam}/playerUsed/${holeIndex}`).set(playerUsed);
          }
          if (player1Score !== null && player2Score !== null) {
            await database.ref(`events/${currentEvent.id}/teams/${selectedTeam}/player1Scores/${holeIndex}`).set(player1Score);
            await database.ref(`events/${currentEvent.id}/teams/${selectedTeam}/player2Scores/${holeIndex}`).set(player2Score);
          }
          if (drivePlayer) {
            await database.ref(`events/${currentEvent.id}/teams/${selectedTeam}/driveUsed/${holeIndex}`).set(drivePlayer);
          }
          
          if (holeOverride === null && team.currentHole < 18) {
            await database.ref(`events/${currentEvent.id}/teams/${selectedTeam}/currentHole`).set(team.currentHole + 1);
          }

          let confirmMessage = `${score} recorded on hole ${holeNum}`;
          if (playerUsed && player1Score !== null && player2Score !== null) {
            confirmMessage = `${team.players[0]}: ${player1Score}, ${team.players[1]}: ${player2Score} → Used ${playerUsed}'s ${score}`;
            if (drivePlayer) {
              confirmMessage += ` (${drivePlayer}'s drive)`;
            }
          }
          
          setScoreConfirmation({
            message: confirmMessage,
            undoData: { holeIndex, previousScore, previousHole, score }
          });

          if (undoTimerRef.current) clearTimeout(undoTimerRef.current);
          undoTimerRef.current = setTimeout(() => {
            setScoreConfirmation(null);
          }, 5000);

        } catch (error) {
          console.error('Error submitting score:', error);
          setScoreConfirmation({ message: 'Error submitting score', undoData: null });
          setTimeout(() => setScoreConfirmation(null), 2000);
        }
      };

      const undoScore = async () => {
        if (!scoreConfirmation?.undoData) return;
        
        const { holeIndex, previousScore, previousHole } = scoreConfirmation.undoData;
        
        try {
          await database.ref(`events/${currentEvent.id}/teams/${selectedTeam}/scores/${holeIndex}`).set(previousScore);
          await database.ref(`events/${currentEvent.id}/teams/${selectedTeam}/currentHole`).set(previousHole);
          
          setScoreConfirmation({ message: 'Score removed', undoData: null });
          setTimeout(() => setScoreConfirmation(null), 2000);
          
        } catch (error) {
          console.error('Error undoing score:', error);
        }
      };

      const copyEventCode = () => {
        const code = currentEvent.meta.eventCode;
        navigator.clipboard.writeText(code).then(() => {
          setFeedback('Code copied!');
          setTimeout(() => setFeedback(''), 2000);
        });
      };

      const toggleTeamExpansion = (teamId) => {
        if (expandedTeams.includes(teamId)) {
          setExpandedTeams(expandedTeams.filter(id => id !== teamId));
        } else {
          setExpandedTeams([...expandedTeams, teamId]);
        }
      };

      const calculateTeamStats = (team) => {
        const scores = team.scores || {};
        const scoresArray = Object.values(scores);
        const validScores = scoresArray.filter(s => s !== null && s !== -1 && s > 0);
        const holesCompleted = validScores.length;
        
        const pars = currentEvent?.meta?.coursePars || [];
        const format = currentEvent?.meta?.format || 'scramble';
        
        if (format === 'stableford') {
          let totalPoints = 0;
          scoresArray.forEach((score, i) => {
            if (score !== null && score !== -1 && score > 0 && pars[i]) {
              totalPoints += calculateStablefordPoints(score, pars[i]);
            }
          });
          return { total: totalPoints, holesCompleted, toPar: 0, isStableford: true };
        } else {
          const total = validScores.reduce((sum, s) => sum + s, 0);
          let parTotal = 0;
          scoresArray.forEach((score, i) => {
            if (score !== null && score !== -1 && score > 0 && pars[i]) {
              parTotal += pars[i];
            }
          });
          const toPar = total - parTotal;
          return { total, holesCompleted, toPar, isStableford: false };
        }
      };

      const validateEventLock = (event) => {
        const format = event.meta.format;
        const teams = Object.values(event.teams || {});
        const registrations = Object.values(event.registrations || {}).filter(r => r.status === 'registered');
        
        // For team events
        if (format !== 'stableford') {
          // Check minimum teams
          if (teams.length < 2) {
            return { valid: false, message: 'Need at least 2 teams to lock event' };
          }
          
          // Check for unassigned players
          const assignedPlayerIds = new Set();
          teams.forEach(team => {
            (team.playerIds || []).forEach(id => assignedPlayerIds.add(id));
          });
          
          const unassignedPlayers = registrations.filter(reg => !assignedPlayerIds.has(reg.uid || Object.keys(event.registrations).find(k => event.registrations[k] === reg)));
          
          if (unassignedPlayers.length > 0) {
            return { valid: false, message: `${unassignedPlayers.length} player(s) not assigned to teams` };
          }
        } else {
          // For individual events
          if (registrations.length < 2) {
            return { valid: false, message: 'Need at least 2 players to lock event' };
          }
        }
        
        return { valid: true };
      };

      // Auth loading screen
      if (authLoading) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900 flex items-center justify-center">
            <div className="text-white text-2xl">Loading...</div>
          </div>
        );
      }

      // LOGIN VIEW
      if (view === 'login') {
        const handleLogin = async (e) => {
          e.preventDefault();
          setAuthError('');
          setAuthLoading2(true);

          try {
            await auth.signInWithEmailAndPassword(loginEmail, loginPassword);
          } catch (err) {
            console.error('Login error:', err);
            if (err.code === 'auth/user-not-found') {
              setAuthError('No account found with this email');
            } else if (err.code === 'auth/wrong-password') {
              setAuthError('Incorrect password');
            } else if (err.code === 'auth/invalid-email') {
              setAuthError('Invalid email address');
            } else {
              setAuthError('Login failed. Please try again.');
            }
          }

          setAuthLoading2(false);
        };

        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900 p-6 flex items-center justify-center">
            <div className="max-w-md w-full">
              <div className="text-center mb-8">
                <h1 className="text-5xl font-bold text-white mb-2" style={{ fontFamily: 'Georgia, serif' }}>LiveLinks</h1>
                <p className="text-blue-200">Golf League Management</p>
              </div>

              <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-8">
                <h2 className="text-2xl font-bold text-gray-900 mb-6">Login</h2>

                {authError && (
                  <div className="bg-red-50 border-2 border-red-200 text-red-800 p-3 rounded-lg mb-4 text-sm">
                    {authError}
                  </div>
                )}

                <form onSubmit={handleLogin} className="space-y-4">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                    <input
                      type="email"
                      value={loginEmail}
                      onChange={(e) => setLoginEmail(e.target.value)}
                      required
                      className="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none"
                      placeholder="your@email.com"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                    <input
                      type="password"
                      value={loginPassword}
                      onChange={(e) => setLoginPassword(e.target.value)}
                      required
                      minLength={6}
                      className="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none"
                      placeholder="••••••••"
                    />
                  </div>

                  <button
                    type="submit"
                    disabled={authLoading2}
                    className="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {authLoading2 ? 'Logging in...' : 'Login'}
                  </button>
                </form>

                <div className="mt-6 text-center">
                  <button
                    onClick={() => {
                      setAuthError('');
                      setView('signup');
                    }}
                    className="text-blue-600 hover:text-blue-700 font-semibold text-sm"
                  >
                    Don't have an account? Sign up
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // SIGNUP VIEW
      if (view === 'signup') {
        const handleSignup = async (e) => {
          e.preventDefault();
          setAuthError('');
          setAuthLoading2(true);

          try {
            const userCredential = await auth.createUserWithEmailAndPassword(signupEmail, signupPassword);
            const user = userCredential.user;

            await database.ref(`users/${user.uid}`).set({
              email: signupEmail,
              displayName: signupDisplayName,
              handicap: signupHandicap ? parseFloat(signupHandicap) : null,
              createdAt: Date.now()
            });

          } catch (err) {
            console.error('Signup error:', err);
            if (err.code === 'auth/email-already-in-use') {
              setAuthError('This email is already registered');
            } else if (err.code === 'auth/invalid-email') {
              setAuthError('Invalid email address');
            } else if (err.code === 'auth/weak-password') {
              setAuthError('Password must be at least 6 characters');
            } else {
              setAuthError('Signup failed. Please try again.');
            }
          }

          setAuthLoading2(false);
        };

        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900 p-6 flex items-center justify-center">
            <div className="max-w-md w-full">
              <div className="text-center mb-8">
                <h1 className="text-5xl font-bold text-white mb-2" style={{ fontFamily: 'Georgia, serif' }}>LiveLinks</h1>
                <p className="text-blue-200">Golf League Management</p>
              </div>

              <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-8">
                <h2 className="text-2xl font-bold text-gray-900 mb-6">Sign Up</h2>

                {authError && (
                  <div className="bg-red-50 border-2 border-red-200 text-red-800 p-3 rounded-lg mb-4 text-sm">
                    {authError}
                  </div>
                )}

                <form onSubmit={handleSignup} className="space-y-4">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Display Name</label>
                    <input
                      type="text"
                      value={signupDisplayName}
                      onChange={(e) => setSignupDisplayName(e.target.value)}
                      required
                      className="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none"
                      placeholder="How you'll appear in the league"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                    <input
                      type="email"
                      value={signupEmail}
                      onChange={(e) => setSignupEmail(e.target.value)}
                      required
                      className="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none"
                      placeholder="your@email.com"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                    <input
                      type="password"
                      value={signupPassword}
                      onChange={(e) => setSignupPassword(e.target.value)}
                      required
                      minLength={6}
                      className="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none"
                      placeholder="Min 6 characters"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Handicap Index (Optional)</label>
                    <input
                      type="number"
                      step="0.1"
                      value={signupHandicap}
                      onChange={(e) => setSignupHandicap(e.target.value)}
                      className="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none"
                      placeholder="e.g. 12.4"
                    />
                  </div>

                  <button
                    type="submit"
                    disabled={authLoading2}
                    className="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {authLoading2 ? 'Creating account...' : 'Sign Up'}
                  </button>
                </form>

                <div className="mt-6 text-center">
                  <button
                    onClick={() => {
                      setAuthError('');
                      setView('login');
                    }}
                    className="text-blue-600 hover:text-blue-700 font-semibold text-sm"
                  >
                    Already have an account? Login
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // CREATE LEAGUE VIEW
      if (view === 'create-league') {
        const handleCreateLeague = async (e) => {
          e.preventDefault();
          setFeedback('');

          if (!newLeague.name) {
            setFeedback('Please enter a league name');
            return;
          }

          if (!userProfile) {
            setFeedback('User profile not loaded. Please try again.');
            return;
          }

          try {
            const leagueId = 'league-' + Date.now();
            const code = await generateLeagueCode();

            const leagueData = {
              meta: {
                name: newLeague.name,
                code: code,
                commissionerId: currentUser.uid,
                description: newLeague.description,
                createdAt: Date.now()
              },
              members: {
                [currentUser.uid]: {
                  displayName: userProfile.displayName,
                  role: 'commissioner',
                  handicap: userProfile.handicap || null,
                  joinedAt: Date.now()
                }
              },
              seasons: {
                'season-2026': {
                  name: newLeague.seasonName,
                  status: 'active',
                  pointSystem: newLeague.pointSystem,
                  events: [],
                  standings: {}
                }
              }
            };

            await database.ref(`leagues/${leagueId}`).set(leagueData);
            await database.ref(`leagueCodes/${code}`).set(leagueId);
            await database.ref(`users/${currentUser.uid}/leagues/${leagueId}`).set({
              role: 'commissioner',
              joinedAt: Date.now()
            });

            const leagues = await loadUserLeagues(currentUser.uid);
            setUserLeagues(leagues);
            setCurrentLeague({ id: leagueId, ...leagueData, userRole: 'commissioner' });
            
            setFeedback(`League created! Code: ${code}`);
            setTimeout(() => {
              setView('league-dashboard');
              setFeedback('');
            }, 1500);

          } catch (error) {
            console.error('Error creating league:', error);
            setFeedback('Error creating league. Please try again.');
          }
        };

        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900 p-6">
            <div className="max-w-2xl mx-auto">
              <button onClick={() => setView('home')} className="text-white mb-6 hover:text-blue-200">← Back</button>

              <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-8">
                <h2 className="text-3xl font-bold text-gray-900 mb-6">Create League</h2>

                {feedback && (
                  <div className="bg-blue-50 border-2 border-blue-200 text-blue-800 p-3 rounded-lg mb-4 text-sm">
                    {feedback}
                  </div>
                )}

                <form onSubmit={handleCreateLeague} className="space-y-5">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">League Name</label>
                    <input
                      type="text"
                      value={newLeague.name}
                      onChange={(e) => setNewLeague({ ...newLeague, name: e.target.value })}
                      required
                      className="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none"
                      placeholder="e.g., Hackers Golf League"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Description (Optional)</label>
                    <textarea
                      value={newLeague.description}
                      onChange={(e) => setNewLeague({ ...newLeague, description: e.target.value })}
                      className="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none"
                      placeholder="e.g., Friday afternoon golf league"
                      rows="2"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Season Name</label>
                    <input
                      type="text"
                      value={newLeague.seasonName}
                      onChange={(e) => setNewLeague({ ...newLeague, seasonName: e.target.value })}
                      required
                      className="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none"
                      placeholder="e.g., 2026 Season"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-3">Point System</label>
                    <div className="grid grid-cols-5 gap-3">
                      {Object.entries(newLeague.pointSystem).map(([place, points]) => (
                        <div key={place}>
                          <label className="block text-xs text-gray-600 mb-1">{place}{place === '1' ? 'st' : place === '2' ? 'nd' : place === '3' ? 'rd' : 'th'}</label>
                          <input
                            type="number"
                            value={points}
                            onChange={(e) => setNewLeague({
                              ...newLeague,
                              pointSystem: { ...newLeague.pointSystem, [place]: parseInt(e.target.value) || 0 }
                            })}
                            className="w-full px-3 py-2 rounded-lg border-2 border-gray-200 focus:border-blue-500 focus:outline-none text-center"
                          />
                        </div>
                      ))}
                    </div>
                  </div>

                  <button
                    type="submit"
                    className="w-full bg-blue-600 text-white py-4 rounded-xl font-semibold hover:bg-blue-700 text-lg"
                  >
                    Create League
                  </button>
                </form>
              </div>
            </div>
          </div>
        );
      }

      // JOIN LEAGUE VIEW
      if (view === 'join-league') {
        const handleJoinLeague = async (e) => {
          e.preventDefault();
          setFeedback('');

          if (!leagueCode.trim()) {
            setFeedback('Please enter a league code');
            return;
          }

          try {
            const codeSnapshot = await database.ref(`leagueCodes/${leagueCode.trim().toUpperCase()}`).once('value');
            const leagueId = codeSnapshot.val();

            if (!leagueId) {
              setFeedback('League not found. Check your code.');
              return;
            }

            const leagueSnapshot = await database.ref(`leagues/${leagueId}`).once('value');
            const leagueData = leagueSnapshot.val();

            if (!leagueData) {
              setFeedback('League not found. Check your code.');
              return;
            }

            if (leagueData.members && leagueData.members[currentUser.uid]) {
              setFeedback('You are already a member of this league');
              setTimeout(() => {
                const league = { id: leagueId, ...leagueData, userRole: leagueData.members[currentUser.uid].role };
                setCurrentLeague(league);
                setView('league-dashboard');
              }, 1500);
              return;
            }

            await database.ref(`leagues/${leagueId}/members/${currentUser.uid}`).set({
              displayName: userProfile.displayName,
              role: 'player',
              handicap: userProfile.handicap || null,
              joinedAt: Date.now()
            });

            await database.ref(`users/${currentUser.uid}/leagues/${leagueId}`).set({
              role: 'player',
              joinedAt: Date.now()
            });

            const leagues = await loadUserLeagues(currentUser.uid);
            setUserLeagues(leagues);
            const joinedLeague = leagues.find(l => l.id === leagueId);
            setCurrentLeague(joinedLeague);

            setFeedback('Successfully joined league!');
            setTimeout(() => {
              setView('league-dashboard');
              setFeedback('');
            }, 1500);

          } catch (error) {
            console.error('Error joining league:', error);
            setFeedback('Error joining league. Please try again.');
          }
        };

        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900 p-6 flex items-center justify-center">
            <div className="max-w-md w-full">
              <button onClick={() => setView('home')} className="text-white mb-6 hover:text-blue-200">← Back</button>

              <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-8">
                <h2 className="text-3xl font-bold text-gray-900 mb-2">Join League</h2>
                <p className="text-gray-600 mb-6">Enter the code from your league commissioner</p>

                {feedback && (
                  <div className={`border-2 p-3 rounded-lg mb-4 text-sm ${
                    feedback.includes('Error') || feedback.includes('not found')
                      ? 'bg-red-50 border-red-200 text-red-800'
                      : 'bg-green-50 border-green-200 text-green-800'
                  }`}>
                    {feedback}
                  </div>
                )}

                <form onSubmit={handleJoinLeague}>
                  <div className="mb-6">
                    <label className="block text-sm font-semibold text-gray-700 mb-2">League Code</label>
                    <input
                      type="text"
                      value={leagueCode}
                      onChange={(e) => setLeagueCode(e.target.value.toUpperCase())}
                      className="w-full px-4 py-4 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none uppercase text-center text-2xl font-mono tracking-widest"
                      placeholder="ABC-1234"
                      maxLength={8}
                    />
                  </div>

                  <button
                    type="submit"
                    className="w-full bg-blue-600 text-white py-4 rounded-xl font-semibold hover:bg-blue-700 text-lg"
                  >
                    Join League
                  </button>
                </form>
              </div>
            </div>
          </div>
        );
      }

      // LEAGUE DASHBOARD VIEW
      if (view === 'league-dashboard' && currentLeague) {
        const isCommissioner = currentLeague.userRole === 'commissioner';
        const members = Object.entries(currentLeague.members || {}).map(([uid, data]) => ({
          uid,
          ...data
        }));
        const activeSeason = Object.values(currentLeague.seasons || {}).find(s => s.status === 'active');

        const handleRemoveMember = async (memberUid, memberName) => {
          if (!confirm(`Remove ${memberName} from the league?`)) {
            return;
          }

          try {
            await database.ref(`leagues/${currentLeague.id}/members/${memberUid}`).remove();
            await database.ref(`users/${memberUid}/leagues/${currentLeague.id}`).remove();

            const leagueSnapshot = await database.ref(`leagues/${currentLeague.id}`).once('value');
            const updatedLeague = leagueSnapshot.val();
            setCurrentLeague({ id: currentLeague.id, ...updatedLeague, userRole: currentLeague.userRole });

            setFeedback(`${memberName} removed from league`);
            setTimeout(() => setFeedback(''), 3000);
          } catch (error) {
            console.error('Error removing member:', error);
            setFeedback('Error removing member');
            setTimeout(() => setFeedback(''), 3000);
          }
        };

        const handleLockEvent = async (event) => {
          const validation = validateEventLock(event);
          
          if (!validation.valid) {
            setEventValidationMessages({ ...eventValidationMessages, [event.id]: validation.message });
            setTimeout(() => {
              setEventValidationMessages(prev => {
                const updated = { ...prev };
                delete updated[event.id];
                return updated;
              });
            }, 5000);
            return;
          }
          
          if (!confirm('Lock this event? Players will no longer be able to register or withdraw.')) {
            return;
          }
          
          try {
            await database.ref(`events/${event.id}/meta/status`).set('locked');
            setEventValidationMessages({ ...eventValidationMessages, [event.id]: 'Event locked successfully!' });
            setTimeout(() => {
              setEventValidationMessages(prev => {
                const updated = { ...prev };
                delete updated[event.id];
                return updated;
              });
            }, 2000);
          } catch (error) {
            console.error('Error locking event:', error);
            setEventValidationMessages({ ...eventValidationMessages, [event.id]: 'Error locking event' });
            setTimeout(() => {
              setEventValidationMessages(prev => {
                const updated = { ...prev };
                delete updated[event.id];
                return updated;
              });
            }, 3000);
          }
        };

        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900 p-6">
            <div className="max-w-2xl mx-auto">
              <button onClick={() => setView('home')} className="text-white mb-6 hover:text-blue-200">← Back to Home</button>

              {/* Header */}
              <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-6 mb-6">
                <h1 className="text-3xl font-bold text-gray-900 mb-2">{currentLeague.meta.name}</h1>
                {currentLeague.meta.description && (
                  <p className="text-gray-600 mb-4">{currentLeague.meta.description}</p>
                )}
                
                <div className="flex items-center gap-3">
                  <div className="bg-blue-50 px-4 py-2 rounded-lg">
                    <div className="text-xs text-gray-600 mb-1">League Code</div>
                    <div className="font-mono font-bold text-blue-600 text-lg">{currentLeague.meta.code}</div>
                  </div>
                  <button
                    onClick={() => {
                      navigator.clipboard.writeText(currentLeague.meta.code);
                      setFeedback('Code copied!');
                      setTimeout(() => setFeedback(''), 2000);
                    }}
                    className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm font-semibold"
                  >
                    Copy Code
                  </button>
                </div>
                {feedback && <div className="mt-2 text-sm text-green-600">{feedback}</div>}
              </div>

              {/* Members */}
              <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-6 mb-6">
                <h2 className="text-xl font-bold text-gray-900 mb-4">Members ({members.length})</h2>
                <div className="space-y-3">
                  {members.map(member => (
                    <div key={member.uid} className="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                      <div>
                        <div className="font-semibold text-gray-900 flex items-center gap-2">
                          {member.displayName}
                          {member.role === 'commissioner' && (
                            <span className="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-semibold">
                              COMMISSIONER
                            </span>
                          )}
                        </div>
                        {member.handicap !== null && (
                          <div className="text-sm text-gray-600">Handicap: {member.handicap}</div>
                        )}
                      </div>
                      {isCommissioner && member.role !== 'commissioner' && (
                        <button
                          onClick={() => handleRemoveMember(member.uid, member.displayName)}
                          className="text-red-600 hover:text-red-700 text-sm font-semibold"
                        >
                          Remove
                        </button>
                      )}
                    </div>
                  ))}
                </div>
              </div>

              {/* Standings */}
              {activeSeason && (
                <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-6 mb-6">
                  <h2 className="text-xl font-bold text-gray-900 mb-4">{activeSeason.name} Standings</h2>
                  {Object.keys(activeSeason.standings || {}).length === 0 ? (
                    <p className="text-gray-600 text-center py-8">No standings yet. Create an event to get started!</p>
                  ) : (
                    <div className="space-y-2">
                      {/* Standings will be populated after events */}
                    </div>
                  )}
                </div>
              )}

              {/* Events */}
              <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-6">
                <h2 className="text-xl font-bold text-gray-900 mb-4">
                  Events ({isCommissioner 
                    ? leagueEvents.length 
                    : leagueEvents.filter(e => e.meta.status !== 'draft').length})
                </h2>
                
                {leagueEvents.length > 0 ? (
                  <div className="space-y-3 mb-4">
                    {leagueEvents.map(event => {
                      const teamCount = Object.keys(event.teams || {}).length;
                      const registrationCount = Object.values(event.registrations || {}).filter(r => r.status === 'registered').length;
                      const status = event.meta.status || 'draft';
                      const statusColors = {
                        draft: 'bg-gray-100 text-gray-700',
                        open: 'bg-blue-100 text-blue-700',
                        locked: 'bg-yellow-100 text-yellow-700',
                        active: 'bg-green-100 text-green-700',
                        complete: 'bg-purple-100 text-purple-700'
                      };
                      const statusLabels = {
                        draft: 'Draft',
                        open: 'Open',
                        locked: 'Locked',
                        active: 'Active',
                        complete: 'Complete'
                      };
                      
                      if (!isCommissioner && status === 'draft') {
                        return null;
                      }
                      
                      return (
                        <div key={event.id} className="bg-gray-50 p-4 rounded-xl">
                          <div className="flex items-start justify-between mb-2">
                            <div>
                              <div className="font-bold text-lg text-gray-900">
                                {event.meta.name}
                              </div>
                              <div className="text-sm text-gray-600">
                                {new Date(event.meta.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                {event.meta.time && ` at ${event.meta.time}`}
                              </div>
                              <div className="text-sm text-gray-600">{event.meta.courseName}</div>
                              <div className="text-sm text-gray-600">{formatNames[event.meta.format]}</div>
                            </div>
                            <span className={`text-xs px-2 py-1 rounded-full font-semibold ${statusColors[status]}`}>
                              {statusLabels[status]}
                            </span>
                          </div>
                          <div className="text-xs text-gray-500 mb-3">
                            {registrationCount} registered · {teamCount} team{teamCount !== 1 ? 's' : ''}
                          </div>
                          
                          {/* Validation/Success Message for this event */}
                          {eventValidationMessages[event.id] && (
                            <div className={`mb-3 p-3 rounded-lg text-sm ${
                              eventValidationMessages[event.id].includes('Error') || eventValidationMessages[event.id].includes('Need') || eventValidationMessages[event.id].includes('not assigned')
                                ? 'bg-red-50 border-2 border-red-200 text-red-800'
                                : 'bg-green-50 border-2 border-green-200 text-green-800'
                            }`}>
                              {eventValidationMessages[event.id]}
                            </div>
                          )}
                          
                          {isCommissioner && (
                            <div className="flex gap-2 flex-wrap">
                              {status === 'draft' && (
                                <>
                                  <button
                                    onClick={() => {
                                      setEditingEvent(event);
                                      setView('edit-event');
                                    }}
                                    className="text-sm bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 font-semibold"
                                  >
                                    Edit
                                  </button>
                                  <button
                                    onClick={async () => {
                                      if (!confirm('Publish this event? Players will be able to see it.')) return;
                                      await database.ref(`events/${event.id}/meta/status`).set('open');
                                      setEventValidationMessages({ ...eventValidationMessages, [event.id]: 'Event published!' });
                                      setTimeout(() => {
                                        setEventValidationMessages(prev => {
                                          const updated = { ...prev };
                                          delete updated[event.id];
                                          return updated;
                                        });
                                      }, 2000);
                                    }}
                                    className="text-sm bg-green-600 text-white px-3 py-1 rounded-lg hover:bg-green-700 font-semibold"
                                  >
                                    Publish
                                  </button>
                                  <button
                                    onClick={async () => {
                                      if (!confirm('Delete this event? This cannot be undone.')) return;
                                      await database.ref(`events/${event.id}`).remove();
                                      await database.ref(`eventCodes/${event.meta.eventCode}`).remove();
                                      const newEvents = activeSeason.events.filter(id => id !== event.id);
                                      await database.ref(`leagues/${currentLeague.id}/seasons/${Object.keys(currentLeague.seasons).find(k => currentLeague.seasons[k].status === 'active')}/events`).set(newEvents);
                                      setLeagueEvents(leagueEvents.filter(e => e.id !== event.id));
                                    }}
                                    className="text-sm bg-red-600 text-white px-3 py-1 rounded-lg hover:bg-red-700 font-semibold"
                                  >
                                    Delete
                                  </button>
                                </>
                              )}
                              {status === 'open' && (
                                <>
                                  <button
                                    onClick={() => {
                                      setEditingEvent(event);
                                      setView('edit-event');
                                    }}
                                    className="text-sm bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 font-semibold"
                                  >
                                    Edit
                                  </button>
                                  <button
                                    onClick={async () => {
                                      if (!confirm('Unpublish this event? Players will no longer see it.')) return;
                                      await database.ref(`events/${event.id}/meta/status`).set('draft');
                                      setEventValidationMessages({ ...eventValidationMessages, [event.id]: 'Event unpublished' });
                                      setTimeout(() => {
                                        setEventValidationMessages(prev => {
                                          const updated = { ...prev };
                                          delete updated[event.id];
                                          return updated;
                                        });
                                      }, 2000);
                                    }}
                                    className="text-sm bg-orange-600 text-white px-3 py-1 rounded-lg hover:bg-orange-700 font-semibold"
                                  >
                                    Unpublish
                                  </button>
                                  <button 
                                    onClick={() => handleLockEvent(event)}
                                    className="text-sm bg-yellow-600 text-white px-3 py-1 rounded-lg hover:bg-yellow-700 font-semibold"
                                  >
                                    Lock
                                  </button>
                                </>
                              )}
                              {status === 'locked' && (
                                <>
                                  <button
                                    onClick={() => {
                                      setEditingEvent(event);
                                      setView('edit-event');
                                    }}
                                    className="text-sm bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 font-semibold"
                                  >
                                    Edit
                                  </button>
                                  <button
                                    onClick={async () => {
                                      if (!confirm('Unlock this event? Players will be able to register and withdraw again.')) return;
                                      await database.ref(`events/${event.id}/meta/status`).set('open');
                                      setEventValidationMessages({ ...eventValidationMessages, [event.id]: 'Event unlocked' });
                                      setTimeout(() => {
                                        setEventValidationMessages(prev => {
                                          const updated = { ...prev };
                                          delete updated[event.id];
                                          return updated;
                                        });
                                      }, 2000);
                                    }}
                                    className="text-sm bg-orange-600 text-white px-3 py-1 rounded-lg hover:bg-orange-700 font-semibold"
                                  >
                                    Unlock
                                  </button>
                                  <button className="text-sm bg-green-600 text-white px-3 py-1 rounded-lg hover:bg-green-700 font-semibold">
                                    Start Event
                                  </button>
                                </>
                              )}
                              {(status === 'active' || status === 'complete') && (
                                <button className="text-sm bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 font-semibold">
                                  View Leaderboard
                                </button>
                              )}
                            </div>
                          )}
                          
                          {!isCommissioner && (
                            <button
                              onClick={() => {
                                setEditingEvent(event);
                                setView('event-details');
                              }}
                              className="text-sm bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 font-semibold"
                            >
                              View Details
                            </button>
                          )}
                          
                          {isCommissioner && status !== 'draft' && (
                            <button
                              onClick={() => {
                                setEditingEvent(event);
                                setView('event-details');
                              }}
                              className="text-sm bg-gray-600 text-white px-3 py-1 rounded-lg hover:bg-gray-700 font-semibold mt-2"
                            >
                              View/Register
                            </button>
                          )}
                        </div>
                      );
                    }).filter(Boolean)}
                  </div>
                ) : (
                  <p className="text-gray-600 text-center py-4 mb-4">No events yet</p>
                )}
                
                {isCommissioner && (
                  <button
                    onClick={() => {
                      const seasonKey = Object.keys(currentLeague.seasons || {}).find(
                        key => currentLeague.seasons[key].status === 'active'
                      );
                      setCreatingEventForLeague({ 
                        leagueId: currentLeague.id, 
                        seasonId: seasonKey 
                      });
                      setView('create-event');
                    }}
                    className="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-blue-700"
                  >
                    + Create Event
                  </button>
                )}
              </div>
            </div>
          </div>
        );
      }

      // HOME VIEW
      if (view === 'home') {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900 p-6 font-sans">
            <div className="max-w-2xl mx-auto">
              <div className="flex justify-between items-center mb-8">
                <div>
                  <h1 className="text-3xl font-bold text-white" style={{ fontFamily: 'Georgia, serif' }}>LiveLinks</h1>
                  {userProfile && (
                    <p className="text-white/80">Welcome, {userProfile.displayName}</p>
                  )}
                </div>
                <button
                  onClick={async () => {
                    await auth.signOut();
                    setView('login');
                  }}
                  className="text-white/80 hover:text-white text-sm font-medium"
                >
                  Logout
                </button>
              </div>

              {/* ADMIN SECTION */}
              {isAdmin() && (
                <div className="mb-6">
                  <h2 className="text-white text-lg font-semibold mb-3">⚙️ ADMIN</h2>
                  <button
                    onClick={() => setView('manage-courses')}
                    className="w-full bg-white/95 backdrop-blur-sm p-5 rounded-2xl shadow-xl hover:bg-white transition-all text-left"
                  >
                    <div className="flex items-center justify-between">
                      <div>
                        <div className="text-xl font-bold text-gray-900">Manage Courses</div>
                        <div className="text-sm text-gray-600">Add and edit golf courses</div>
                      </div>
                      <div className="text-gray-400">›</div>
                    </div>
                  </button>
                </div>
              )}

              {userLeagues.length > 0 && (
                <div className="mb-6">
                  <h2 className="text-white text-lg font-semibold mb-3">MY LEAGUES</h2>
                  <div className="space-y-3">
                    {userLeagues.map(league => (
                      <button
                        key={league.id}
                        onClick={() => {
                          setCurrentLeague(league);
                          setView('league-dashboard');
                        }}
                        className="w-full bg-white/95 backdrop-blur-sm p-5 rounded-2xl shadow-xl hover:bg-white transition-all text-left"
                      >
                        <div className="flex items-center justify-between">
                          <div>
                            <div className="text-xl font-bold text-gray-900 flex items-center gap-2">
                              {league.meta.name}
                              {league.userRole === 'commissioner' && (
                                <span className="text-yellow-500">⭐</span>
                              )}
                            </div>
                            <div className="text-sm text-gray-600">
                              {league.userRole === 'commissioner' ? 'Commissioner' : 'Player'} · {Object.keys(league.seasons || {}).length} season{Object.keys(league.seasons || {}).length !== 1 ? 's' : ''}
                            </div>
                          </div>
                          <div className="text-gray-400">›</div>
                        </div>
                      </button>
                    ))}
                  </div>
                </div>
              )}

              <div className="mb-6">
                <div className="grid grid-cols-2 gap-3">
                  <button
                    onClick={() => setView('create-league')}
                    className="bg-white/95 backdrop-blur-sm p-5 rounded-2xl shadow-xl hover:bg-white transition-all"
                  >
                    <div className="text-center">
                      <div className="text-3xl mb-2">🏆</div>
                      <div className="font-bold text-gray-900">Create League</div>
                    </div>
                  </button>
                  <button
                    onClick={() => setView('join-league')}
                    className="bg-white/95 backdrop-blur-sm p-5 rounded-2xl shadow-xl hover:bg-white transition-all"
                  >
                    <div className="text-center">
                      <div className="text-3xl mb-2">🤝</div>
                      <div className="font-bold text-gray-900">Join League</div>
                    </div>
                  </button>
                </div>
              </div>

              <div className="bg-white/10 backdrop-blur-sm rounded-2xl p-6">
                <h3 className="text-white text-sm font-semibold mb-3 uppercase tracking-wider">Quick Play</h3>
                <p className="text-white/70 text-sm mb-4">For one-off events without a league</p>
                
                <div className="space-y-3">
                  <button
                    onClick={() => setView('create-event')}
                    className="w-full bg-white/20 hover:bg-white/30 p-4 rounded-xl transition-all text-white text-left"
                  >
                    <div className="font-semibold">Create Event</div>
                    <div className="text-sm text-white/80">Host a standalone golf event</div>
                  </button>

                  <div className="bg-white/20 p-4 rounded-xl">
                    <div className="font-semibold text-white mb-3">Join Event</div>
                    <div className="flex gap-2">
                      <input
                        type="text"
                        value={joinCode}
                        onChange={(e) => setJoinCode(e.target.value.toUpperCase())}
                        onKeyPress={(e) => e.key === 'Enter' && joinEvent()}
                        placeholder="WOLF-A3X9"
                        className="flex-1 px-4 py-2 rounded-lg border-2 border-white/30 bg-white/10 text-white placeholder-white/50 focus:border-white/50 focus:outline-none uppercase"
                      />
                      <button
                        onClick={joinEvent}
                        className="bg-white text-blue-900 px-5 py-2 rounded-lg hover:bg-white/90 font-semibold"
                      >
                        Join
                      </button>
                    </div>
                    {feedback && <div className="mt-2 text-sm text-white/90">{feedback}</div>}
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // CREATE EVENT VIEW
      if (view === 'create-event') {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900 p-6">
            <div className="max-w-2xl mx-auto">
              <button 
                onClick={() => {
                  if (creatingEventForLeague) {
                    setCreatingEventForLeague(null);
                    setView('league-dashboard');
                  } else {
                    setView('home');
                  }
                }} 
                className="text-white mb-6 hover:text-blue-200"
              >
                ← Back
              </button>
              <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-8">
                <h2 className="text-3xl font-bold text-gray-900 mb-6" style={{ fontFamily: 'Georgia, serif' }}>Create Event</h2>
                {creatingEventForLeague && (
                  <div className="bg-blue-50 border-2 border-blue-200 p-3 rounded-lg mb-6">
                    <div className="text-sm text-blue-800">Creating event for <strong>{currentLeague?.meta?.name}</strong></div>
                  </div>
                )}
                
                <div className="space-y-6">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Event Name</label>
                    <input
                      type="text"
                      value={newEvent.name}
                      onChange={(e) => setNewEvent({ ...newEvent, name: e.target.value })}
                      placeholder="March Scramble"
                      className="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Course</label>
                    <select
                      value={selectedBaseCourse}
                      onChange={(e) => {
                        setSelectedBaseCourse(e.target.value);
                        setNewEvent({ ...newEvent, courseId: '' }); // Reset tee selection
                      }}
                      className="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none"
                    >
                      <option value="">Select a course</option>
                      {globalCourses.map(course => (
                        <option key={course.id} value={course.id}>
                          {course.name} {course.location && `- ${course.location}`}
                        </option>
                      ))}
                    </select>
                  </div>

                  {selectedBaseCourse && (
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Tee</label>
                      <select
                        value={newEvent.courseId}
                        onChange={(e) => setNewEvent({ ...newEvent, courseId: e.target.value })}
                        className="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none"
                      >
                        <option value="">Select a tee</option>
                        {courses
                          .filter(c => c.courseId === selectedBaseCourse)
                          .map(course => {
                            const totalYards = course.yardages?.reduce((sum, y) => sum + (parseInt(y) || 0), 0) || 0;
                            return (
                              <option key={course.id} value={course.id}>
                                {course.teeName} - Rating: {course.rating} / Slope: {course.slope} / {totalYards} yards
                              </option>
                            );
                          })}
                      </select>
                    </div>
                  )}

                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Format</label>
                    <select
                      value={newEvent.format}
                      onChange={(e) => setNewEvent({ ...newEvent, format: e.target.value, teams: [] })}
                      className="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none"
                    >
                      <option value="scramble">2-Man Scramble</option>
                      <option value="shamble">2-Man Shamble</option>
                      <option value="bestball">2-Man Best Ball</option>
                      <option value="stableford">Individual Stableford</option>
                    </select>
                    <p className="text-xs text-gray-600 mt-2">{formatDescriptions[newEvent.format]}</p>
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Date</label>
                      <input
                        type="date"
                        value={newEvent.date}
                        onChange={(e) => setNewEvent({ ...newEvent, date: e.target.value })}
                        className="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Time (Optional)</label>
                      <input
                        type="time"
                        value={newEvent.time}
                        onChange={(e) => setNewEvent({ ...newEvent, time: e.target.value })}
                        className="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none"
                      />
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Starting Hole</label>
                    <div className="grid grid-cols-2 gap-3">
                      <button
                        type="button"
                        onClick={() => setNewEvent({ ...newEvent, startingHole: 1 })}
                        className={`py-3 rounded-xl font-semibold transition-all ${
                          newEvent.startingHole === 1
                            ? 'bg-blue-600 text-white'
                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                        }`}
                      >
                        Hole 1 (Front 9)
                      </button>
                      <button
                        type="button"
                        onClick={() => setNewEvent({ ...newEvent, startingHole: 10 })}
                        className={`py-3 rounded-xl font-semibold transition-all ${
                          newEvent.startingHole === 10
                            ? 'bg-blue-600 text-white'
                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                        }`}
                      >
                        Hole 10 (Back 9)
                      </button>
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-3">
                      {newEvent.format === 'stableford' ? 'Players' : 'Teams'} ({newEvent.teams.length})
                      {creatingEventForLeague && (
                        <span className="ml-2 text-xs font-normal text-gray-500">(Optional - can add later)</span>
                      )}
                    </label>
                    
                    {newEvent.teams.length > 0 && (
                      <div className="space-y-2 mb-4">
                        {newEvent.teams.map(team => (
                          <div key={team.id} className="bg-gray-50 p-4 rounded-xl flex items-center justify-between">
                            <div>
                              <div className="font-semibold text-gray-900">{team.name}</div>
                              {newEvent.format !== 'stableford' && (
                                <div className="text-sm text-gray-600">{team.player1} & {team.player2}</div>
                              )}
                            </div>
                            <button onClick={() => removeTeam(team.id)} className="text-red-600 hover:text-red-700 p-2">
                              <Trash />
                            </button>
                          </div>
                        ))}
                      </div>
                    )}

                    {newEvent.teams.length < (newEvent.format === 'stableford' ? 20 : 6) && (
                      <div className="bg-blue-50 p-4 rounded-xl space-y-3">
                        {newEvent.format === 'stableford' ? (
                          <>
                            <input
                              type="text"
                              value={newTeam.name}
                              onChange={(e) => setNewTeam({ ...newTeam, name: e.target.value })}
                              placeholder="Player name"
                              className="w-full px-4 py-2 rounded-lg border-2 border-blue-200 focus:border-blue-500 focus:outline-none"
                            />
                            <button
                              onClick={addTeam}
                              className="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 font-semibold"
                            >
                              Add Player
                            </button>
                          </>
                        ) : (
                          <>
                            <input
                              type="text"
                              value={newTeam.name}
                              onChange={(e) => setNewTeam({ ...newTeam, name: e.target.value })}
                              placeholder="Team name"
                              className="w-full px-4 py-2 rounded-lg border-2 border-blue-200 focus:border-blue-500 focus:outline-none"
                            />
                            <div className="grid grid-cols-2 gap-3">
                              <input
                                type="text"
                                value={newTeam.player1}
                                onChange={(e) => setNewTeam({ ...newTeam, player1: e.target.value })}
                                placeholder="Player 1"
                                className="px-4 py-2 rounded-lg border-2 border-blue-200 focus:border-blue-500 focus:outline-none"
                              />
                              <input
                                type="text"
                                value={newTeam.player2}
                                onChange={(e) => setNewTeam({ ...newTeam, player2: e.target.value })}
                                placeholder="Player 2"
                                className="px-4 py-2 rounded-lg border-2 border-blue-200 focus:border-blue-500 focus:outline-none"
                              />
                            </div>
                            <button
                              onClick={addTeam}
                              className="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 font-semibold"
                            >
                              Add Team
                            </button>
                          </>
                        )}
                      </div>
                    )}
                  </div>

                  {feedback && (
                    <div className="bg-blue-50 border-2 border-blue-200 text-blue-800 px-4 py-3 rounded-xl text-sm">
                      {feedback}
                    </div>
                  )}

                  <button
                    onClick={createEvent}
                    className="w-full bg-blue-600 text-white py-4 rounded-xl font-semibold text-lg hover:bg-blue-700 shadow-lg"
                  >
                    Create Event
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // EDIT EVENT VIEW (CONTINUED WITH BUG FIXES)
      if (view === 'edit-event' && editingEvent && editForm) {
        const saveEventEdits = async () => {
          try {
            const course = courses.find(c => c.id === editForm.courseId);
            
            // Prepare updates object
            const updates = {
              [`events/${editingEvent.id}/meta/name`]: editForm.name,
              [`events/${editingEvent.id}/meta/courseId`]: course.id,
              [`events/${editingEvent.id}/meta/courseName`]: course.name,
              [`events/${editingEvent.id}/meta/coursePars`]: course.holes,
              [`events/${editingEvent.id}/meta/date`]: editForm.date,
              [`events/${editingEvent.id}/meta/time`]: editForm.time || null,
              [`events/${editingEvent.id}/meta/format`]: editForm.format
            };

            // Save teams with their current data preserved
            const currentTeamsSnapshot = await database.ref(`events/${editingEvent.id}/teams`).once('value');
            const currentTeams = currentTeamsSnapshot.val() || {};
            
            // Keep all current team data
            updates[`events/${editingEvent.id}/teams`] = currentTeams;

            await database.ref().update(updates);
            
            setFeedback('Event updated!');
            setTimeout(() => {
              setEditingEvent(null);
              setView('league-dashboard');
              setFeedback('');
            }, 1500);
          } catch (error) {
            console.error('Error updating event:', error);
            setFeedback('Error updating event');
          }
        };

        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900 p-6">
            <div className="max-w-2xl mx-auto">
              <button onClick={() => { setEditingEvent(null); setView('league-dashboard'); }} className="text-white mb-6 hover:text-blue-200">← Back</button>
              
              <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-8">
                <h2 className="text-3xl font-bold text-gray-900 mb-6">Edit Event</h2>

                {feedback && (
                  <div className={`border-2 p-3 rounded-lg mb-4 text-sm ${
                    feedback.includes('Error') || feedback.includes('not found')
                      ? 'bg-red-50 border-red-200 text-red-800'
                      : feedback.includes('Player') || feedback.includes('Team')
                      ? 'bg-green-50 border-green-200 text-green-800'
                      : 'bg-blue-50 border-blue-200 text-blue-800'
                  }`}>
                    {feedback}
                  </div>
                )}

                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Event Name</label>
                    <input
                      type="text"
                      value={editForm.name}
                      onChange={(e) => setEditForm({ ...editForm, name: e.target.value })}
                      className="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Course</label>
                    <select
                      value={(() => {
                        // Extract base course ID from the combined courseId
                        const selectedCourse = courses.find(c => c.id === editForm.courseId);
                        return selectedCourse?.courseId || '';
                      })()}
                      onChange={(e) => {
                        // When course changes, reset the tee selection
                        setEditForm({ ...editForm, courseId: '' });
                      }}
                      className="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none"
                    >
                      <option value="">Select a course</option>
                      {globalCourses.map(course => (
                        <option key={course.id} value={course.id}>
                          {course.name} {course.location && `- ${course.location}`}
                        </option>
                      ))}
                    </select>
                  </div>

                  {(() => {
                    const selectedCourse = courses.find(c => c.id === editForm.courseId);
                    const baseCourseId = selectedCourse?.courseId;
                    return baseCourseId ? (
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">Tee</label>
                        <select
                          value={editForm.courseId}
                          onChange={(e) => setEditForm({ ...editForm, courseId: e.target.value })}
                          className="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none"
                        >
                          <option value="">Select a tee</option>
                          {courses
                            .filter(c => c.courseId === baseCourseId)
                            .map(course => {
                              const totalYards = course.yardages?.reduce((sum, y) => sum + (parseInt(y) || 0), 0) || 0;
                              return (
                                <option key={course.id} value={course.id}>
                                  {course.teeName} - Rating: {course.rating} / Slope: {course.slope} / {totalYards} yards
                                </option>
                              );
                            })}
                        </select>
                      </div>
                    ) : null;
                  })()}

                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Date</label>
                      <input
                        type="date"
                        value={editForm.date}
                        onChange={(e) => setEditForm({ ...editForm, date: e.target.value })}
                        className="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Time</label>
                      <input
                        type="time"
                        value={editForm.time}
                        onChange={(e) => setEditForm({ ...editForm, time: e.target.value })}
                        className="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none"
                      />
                    </div>
                  </div>

                  {/* REGISTRATION MANAGEMENT */}
                  {editingEvent.meta.leagueId && (
                    <div className="border-t-2 border-gray-200 pt-6 mt-6">
                      <h3 className="text-lg font-bold text-gray-900 mb-4">Registered Players</h3>
                      
                      {(() => {
                        const registeredPlayers = Object.entries(eventRegistrations || {})
                          .filter(([_, reg]) => reg.status === 'registered')
                          .map(([uid, reg]) => ({ uid, ...reg }));
                        
                        const leagueMembers = Object.entries(currentLeague?.members || {})
                          .map(([uid, data]) => ({ uid, ...data }))
                          .filter(m => !registeredPlayers.find(p => p.uid === m.uid));
                        
                        return (
                          <>
                            {registeredPlayers.length > 0 ? (
                              <div className="space-y-2 mb-4">
                                {registeredPlayers.map(player => (
                                  <div key={player.uid} className="flex items-center justify-between bg-gray-50 p-3 rounded-xl">
                                    <div>
                                      <span className="font-semibold">{player.displayName}</span>
                                      {player.handicap != null && <span className="text-gray-600 text-sm ml-2">({player.handicap})</span>}
                                      {player.addedBy === 'commissioner' && (
                                        <span className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded ml-2">Added by you</span>
                                      )}
                                    </div>
                                    <button
                                      onClick={() => removePlayerFromEvent(editingEvent.id, player.uid)}
                                      className="text-red-600 hover:text-red-700 text-sm font-semibold"
                                    >
                                      Remove
                                    </button>
                                  </div>
                                ))}
                              </div>
                            ) : (
                              <p className="text-gray-500 text-sm mb-4">No players registered yet</p>
                            )}
                            
                            {leagueMembers.length > 0 && (
                              <div className="bg-blue-50 p-4 rounded-xl">
                                <label className="block text-sm font-semibold text-gray-700 mb-2">Add League Member</label>
                                <select
                                  onChange={(e) => {
                                    if (e.target.value) {
                                      const member = leagueMembers.find(m => m.uid === e.target.value);
                                      if (member) {
                                        addPlayerToEvent(editingEvent.id, member.uid, member.displayName, member.handicap);
                                        e.target.value = '';
                                      }
                                    }
                                  }}
                                  className="w-full px-4 py-2 rounded-lg border-2 border-blue-200 focus:border-blue-500 focus:outline-none"
                                >
                                  <option value="">Select a player...</option>
                                  {leagueMembers.map(member => (
                                    <option key={member.uid} value={member.uid}>
                                      {member.displayName} {member.handicap != null ? `(${member.handicap})` : ''}
                                    </option>
                                  ))}
                                </select>
                              </div>
                            )}
                          </>
                        );
                      })()}
                    </div>
                  )}

                  {/* TEAM ASSIGNMENT (for team events only) */}
                  {editingEvent.meta.leagueId && editForm.format !== 'stableford' && (
                    <div className="border-t-2 border-gray-200 pt-6 mt-6">
                      <h3 className="text-lg font-bold text-gray-900 mb-4">Team Assignment</h3>
                      
                      {(() => {
                        const registeredPlayers = Object.entries(eventRegistrations || {})
                          .filter(([_, reg]) => reg.status === 'registered')
                          .map(([uid, reg]) => ({ uid, ...reg }));
                        
                        const assignedPlayerIds = new Set();
                        Object.values(editingEvent.teams || {}).forEach(team => {
                          (team.playerIds || []).forEach(id => assignedPlayerIds.add(id));
                        });
                        
                        const unassignedPlayers = registeredPlayers.filter(p => !assignedPlayerIds.has(p.uid));
                        
                        return (
                          <>
                            {unassignedPlayers.length > 0 && (
                              <div className="mb-6">
                                <div className="text-sm font-semibold text-gray-700 mb-2">
                                  Unassigned Players ({unassignedPlayers.length})
                                </div>
                                <div className="bg-yellow-50 border-2 border-yellow-200 p-4 rounded-xl">
                                  <div className="space-y-2">
                                    {unassignedPlayers.map(player => (
                                      <div key={player.uid} className="text-sm">
                                        <span className="font-semibold">{player.displayName}</span>
                                        {player.handicap != null && <span className="text-gray-600 ml-2">({player.handicap})</span>}
                                      </div>
                                    ))}
                                  </div>
                                </div>
                              </div>
                            )}
                            
                            <div className="mb-4">
                              <div className="text-sm font-semibold text-gray-700 mb-2">
                                Teams ({Object.keys(editingEvent.teams || {}).length})
                              </div>
                              
                              {Object.keys(editingEvent.teams || {}).length > 0 ? (
                                <div className="space-y-3">
                                  {Object.entries(editingEvent.teams || {}).map(([teamKey, team]) => (
                                    <div key={teamKey} className="bg-gray-50 border-2 border-gray-200 p-4 rounded-xl">
                                      {/* Team Name - Editable */}
                                      <div className="mb-3">
                                        {editingTeamName === teamKey ? (
                                          <div className="flex gap-2">
                                            <input
                                              type="text"
                                              value={tempTeamName}
                                              onChange={(e) => setTempTeamName(e.target.value)}
                                              className="flex-1 px-3 py-2 rounded-lg border-2 border-blue-500 focus:outline-none font-semibold"
                                              autoFocus
                                              onKeyPress={(e) => {
                                                if (e.key === 'Enter' && tempTeamName.trim()) {
                                                  updateTeamName(editingEvent.id, teamKey, tempTeamName.trim());
                                                }
                                              }}
                                            />
                                            <button
                                              onClick={() => {
                                                if (tempTeamName.trim()) {
                                                  updateTeamName(editingEvent.id, teamKey, tempTeamName.trim());
                                                }
                                              }}
                                              className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 font-semibold text-sm"
                                            >
                                              Save
                                            </button>
                                            <button
                                              onClick={() => {
                                                setEditingTeamName(null);
                                                setTempTeamName('');
                                              }}
                                              className="bg-gray-400 text-white px-4 py-2 rounded-lg hover:bg-gray-500 font-semibold text-sm"
                                            >
                                              Cancel
                                            </button>
                                          </div>
                                        ) : (
                                          <div className="flex items-center gap-2">
                                            <span className="font-semibold text-gray-900 flex-1">{team.name}</span>
                                            <button
                                              onClick={() => {
                                                setEditingTeamName(teamKey);
                                                setTempTeamName(team.name);
                                              }}
                                              className="text-blue-600 hover:text-blue-700 p-1"
                                              title="Edit team name"
                                            >
                                              <Edit />
                                            </button>
                                          </div>
                                        )}
                                      </div>
                                      
                                      {/* Team members */}
                                      {(team.playerIds || []).length > 0 ? (
                                        <div className="space-y-1 mb-3">
                                          {team.playerIds.map((playerId, idx) => (
                                            <div key={playerId} className="flex items-center justify-between text-sm">
                                              <span>{team.players[idx]}</span>
                                              <button
                                                onClick={() => removePlayerFromTeam(editingEvent.id, teamKey, playerId)}
                                                className="text-red-600 hover:text-red-700 text-xs font-semibold"
                                              >
                                                Remove
                                              </button>
                                            </div>
                                          ))}
                                        </div>
                                      ) : (
                                        <div className="text-sm text-gray-500 mb-3">(empty team)</div>
                                      )}
                                      
                                      {/* Add player to team */}
                                      {unassignedPlayers.length > 0 && (team.playerIds || []).length < 2 && (
                                        <select
                                          onChange={(e) => {
                                            if (e.target.value) {
                                              const player = unassignedPlayers.find(p => p.uid === e.target.value);
                                              if (player) {
                                                assignPlayerToTeam(editingEvent.id, teamKey, player.uid, player.displayName);
                                              }
                                              e.target.value = '';
                                            }
                                          }}
                                          className="w-full px-3 py-2 text-sm rounded-lg border-2 border-gray-200 focus:border-blue-500 focus:outline-none"
                                        >
                                          <option value="">+ Add Player</option>
                                          {unassignedPlayers.map(player => (
                                            <option key={player.uid} value={player.uid}>
                                              {player.displayName} {player.handicap != null ? `(${player.handicap})` : ''}
                                            </option>
                                          ))}
                                        </select>
                                      )}
                                    </div>
                                  ))}
                                </div>
                              ) : (
                                <p className="text-gray-500 text-sm">No teams yet</p>
                              )}
                              
                              <button
                                onClick={() => createNewTeam(editingEvent.id)}
                                className="w-full mt-3 bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700 font-semibold text-sm"
                              >
                                + Add Team
                              </button>
                            </div>
                          </>
                        );
                      })()}
                    </div>
                  )}

                  <button onClick={saveEventEdits} className="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-blue-700">
                    Save Changes
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // EVENT DETAILS VIEW (for players viewing locked/open events)
      if (view === 'event-details' && editingEvent) {
        const teamCount = Object.keys(editingEvent.teams || {}).length;
        const status = editingEvent.meta.status || 'draft';

        const registeredPlayers = Object.entries(eventRegistrations || {})
          .filter(([_, reg]) => reg.status === 'registered')
          .map(([uid, reg]) => ({ uid, ...reg }));

        const userRegistration = currentUser ? eventRegistrations[currentUser.uid] : null;
        const isRegistered = userRegistration?.status === 'registered';
        const canRegister = status === 'open';

        // Find user's team if assigned
        let userTeam = null;
        let userTeamKey = null;
        if (isRegistered && currentUser) {
          for (const [teamKey, team] of Object.entries(editingEvent.teams || {})) {
            if (team.playerIds && team.playerIds.includes(currentUser.uid)) {
              userTeam = team;
              userTeamKey = teamKey;
              break;
            }
          }
        }

        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900 p-6">
            <div className="max-w-2xl mx-auto">
              <button onClick={() => { setEditingEvent(null); setEventRegistrations({}); setView('league-dashboard'); }} className="text-white mb-6 hover:text-blue-200">← Back</button>
              
              <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-8">
                <h2 className="text-3xl font-bold text-gray-900 mb-2">{editingEvent.meta.name}</h2>
                <div className="text-gray-600 mb-6">
                  {new Date(editingEvent.meta.date).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}
                  {editingEvent.meta.time && ` at ${editingEvent.meta.time}`}
                </div>

                {feedback && (
                  <div className={`border-2 p-3 rounded-lg mb-4 text-sm ${
                    feedback.includes('Error') || feedback.includes('not found')
                      ? 'bg-red-50 border-red-200 text-red-800'
                      : 'bg-green-50 border-green-200 text-green-800'
                  }`}>
                    {feedback}
                  </div>
                )}

                {/* Registration Status/Actions */}
                {canRegister && !isRegistered && (
                  <button
                    onClick={() => registerForEvent(editingEvent.id)}
                    className="w-full bg-green-600 text-white py-3 rounded-xl font-semibold hover:bg-green-700 mb-6"
                  >
                    Register for this Event
                  </button>
                )}

                {/* Locked event - not registered */}
                {status === 'locked' && !isRegistered && (
                  <div className="bg-yellow-50 border-2 border-yellow-200 p-4 rounded-xl mb-6">
                    <div className="text-yellow-800 text-sm">
                      Registration is closed for this event.
                    </div>
                  </div>
                )}

                {/* User's registration and team status */}
                {isRegistered && (
                  <div className="mb-6">
                    <div className="bg-green-50 border-2 border-green-200 p-4 rounded-xl mb-3">
                      <div className="flex items-center text-green-800">
                        <span className="text-lg mr-2">✓</span>
                        <span className="font-semibold">You're Registered</span>
                      </div>
                      {userTeam && (
                        <div className="mt-3 p-3 bg-blue-50 border-2 border-blue-300 rounded-lg">
                          <div className="text-sm text-blue-700 font-semibold mb-2">Your Team</div>
                          <div className="font-bold text-blue-900 text-lg">{userTeam.name}</div>
                          <div className="text-sm text-blue-700 mt-1">
                            {userTeam.players.map((player, idx) => (
                              <div key={idx} className={currentUser && userTeam.playerIds[idx] === currentUser.uid ? 'font-bold' : ''}>
                                {currentUser && userTeam.playerIds[idx] === currentUser.uid ? '→ ' : ''}{player}
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                      {!userTeam && (status === 'locked' || status === 'active') && (
                        <div className="text-sm text-green-700 mt-2">
                          Teams not yet announced
                        </div>
                      )}
                      {!userTeam && status === 'open' && (
                        <div className="text-sm text-green-700 mt-2">
                          Not yet assigned to a team
                        </div>
                      )}
                    </div>
                    {canRegister && (
                      <button
                        onClick={() => withdrawFromEvent(editingEvent.id)}
                        className="w-full bg-red-600 text-white py-2 rounded-xl font-semibold hover:bg-red-700"
                      >
                        Withdraw
                      </button>
                    )}
                  </div>
                )}

                <div className="space-y-4">
                  <div className="bg-gray-50 p-4 rounded-xl">
                    <div className="text-sm text-gray-600 mb-1">Course</div>
                    <div className="font-semibold text-gray-900">{editingEvent.meta.courseName}</div>
                  </div>

                  <div className="bg-gray-50 p-4 rounded-xl">
                    <div className="text-sm text-gray-600 mb-1">Format</div>
                    <div className="font-semibold text-gray-900">{formatNames[editingEvent.meta.format]}</div>
                    <div className="text-xs text-gray-600 mt-1">{formatDescriptions[editingEvent.meta.format]}</div>
                  </div>

                  <div className="bg-gray-50 p-4 rounded-xl">
                    <div className="text-sm text-gray-600 mb-1">Status</div>
                    <div className="font-semibold text-gray-900 capitalize">{status}</div>
                  </div>

                  {/* Registered Players */}
                  {registeredPlayers.length > 0 && (
                    <div className="bg-gray-50 p-4 rounded-xl">
                      <div className="text-sm text-gray-600 mb-2">Registered ({registeredPlayers.length})</div>
                      <div className="space-y-1">
                        {registeredPlayers.map((player) => {
                          let playerTeam = null;
                          let playerTeamKey = null;
                          for (const [teamKey, team] of Object.entries(editingEvent.teams || {})) {
                            if (team.playerIds && team.playerIds.includes(player.uid)) {
                              playerTeam = team;
                              playerTeamKey = teamKey;
                              break;
                            }
                          }
                          
                          const isCurrentUser = currentUser && player.uid === currentUser.uid;
                          
                          return (
                            <div key={player.uid} className={`text-sm flex items-center justify-between p-2 rounded ${isCurrentUser ? 'bg-blue-100 border border-blue-300' : ''}`}>
                              <div>
                                <span className="mr-1">✓</span>
                                <span className={`font-semibold ${isCurrentUser ? 'text-blue-900' : ''}`}>
                                  {player.displayName} {isCurrentUser && '(You)'}
                                </span>
                                {player.handicap != null && <span className="text-gray-600"> ({player.handicap})</span>}
                              </div>
                              {playerTeam && (
                                <span className={`text-xs ${isCurrentUser ? 'text-blue-700 font-semibold' : 'text-gray-500'}`}>
                                  Team: {playerTeam.name}
                                </span>
                              )}
                              {!playerTeam && (status === 'locked' || status === 'active') && (
                                <span className="text-xs text-gray-500">Unassigned</span>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  )}

                  {/* Teams view for locked/active events */}
                  {teamCount > 0 && (status === 'locked' || status === 'active') && (
                    <div className="bg-gray-50 p-4 rounded-xl">
                      <div className="text-sm text-gray-600 mb-2">Teams ({teamCount})</div>
                      <div className="space-y-2">
                        {Object.entries(editingEvent.teams).map(([teamKey, team], idx) => {
                          const isUserTeam = userTeamKey === teamKey;
                          return (
                            <div key={idx} className={`text-sm p-3 rounded-lg ${isUserTeam ? 'bg-blue-100 border-2 border-blue-400' : 'bg-white'}`}>
                              <span className={`font-semibold ${isUserTeam ? 'text-blue-900' : ''}`}>
                                {team.name} {isUserTeam && '(Your Team)'}
                              </span>
                              <div className={`text-xs mt-1 ${isUserTeam ? 'text-blue-700' : 'text-gray-600'}`}>
                                {team.players.map((player, pidx) => (
                                  <div key={pidx} className={currentUser && team.playerIds && team.playerIds[pidx] === currentUser.uid ? 'font-bold' : ''}>
                                    {currentUser && team.playerIds && team.playerIds[pidx] === currentUser.uid ? '→ ' : ''}{player}
                                  </div>
                                ))}
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        );
      }

      // EVENT LOBBY VIEW
      if (view === 'event-lobby' && currentEvent) {
        const teams = Object.entries(currentEvent.teams || {});
        
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900 p-6">
            <div className="max-w-2xl mx-auto">
              <button onClick={() => { setView('home'); setCurrentEvent(null); }} className="text-white mb-6 hover:text-blue-200">← Leave Event</button>
              
              <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-8">
                <div className="text-center mb-8">
                  <h2 className="text-3xl font-bold text-gray-900 mb-2">{currentEvent.meta.name}</h2>
                  <p className="text-gray-600 mb-2">{currentEvent.meta.courseName} - {currentEvent.meta.date}</p>
                  <p className="text-sm text-gray-500 mb-4">{formatNames[currentEvent.meta.format || 'scramble']}</p>
                  <div className="inline-block bg-blue-50 px-4 py-2 rounded-lg">
                    <div className="text-xs text-gray-600 mb-1">Event Code</div>
                    <div className="font-mono font-bold text-blue-600 text-xl">{currentEvent.meta.eventCode}</div>
                  </div>
                </div>

                <div className="mb-6">
                  <h3 className="text-lg font-semibold text-gray-900 mb-3">Teams</h3>
                  <div className="space-y-3">
                    {teams.map(([teamId, team]) => (
                      <div key={teamId} className="bg-gray-50 p-4 rounded-xl">
                        <div className="font-semibold text-gray-900 mb-1">{team.name}</div>
                        <div className="text-sm text-gray-600">{team.players.join(' & ')}</div>
                      </div>
                    ))}
                  </div>
                </div>

                <button
                  onClick={() => setView('team-selection')}
                  className="w-full bg-blue-600 text-white py-4 rounded-xl font-semibold text-lg hover:bg-blue-700 shadow-lg"
                >
                  Select Team & Start Scoring
                </button>
              </div>
            </div>
          </div>
        );
      }

      // TEAM SELECTION VIEW
      if (view === 'team-selection' && currentEvent) {
        const teams = Object.entries(currentEvent.teams || {});
        const isStableford = currentEvent.meta.format === 'stableford';
        
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900 p-6">
            <div className="max-w-2xl mx-auto">
              <button onClick={() => setView('event-lobby')} className="text-white mb-6 hover:text-blue-200">← Back</button>
              
              <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-8">
                <h2 className="text-3xl font-bold text-gray-900 mb-2" style={{ fontFamily: 'Georgia, serif' }}>
                  {isStableford ? 'Select Your Player' : 'Select Your Team'}
                </h2>
                <p className="text-gray-600 mb-8">
                  {isStableford ? 'Choose which player you\'re scoring for' : 'Choose which team you\'re scoring for'}
                </p>
                
                <div className="space-y-3">
                  {teams.map(([teamId, team]) => (
                    <button
                      key={teamId}
                      onClick={() => selectTeam(teamId)}
                      className="w-full bg-gray-50 hover:bg-blue-50 p-6 rounded-xl transition-all text-left border-2 border-transparent hover:border-blue-500"
                    >
                      <div className="font-bold text-xl text-gray-900 mb-2">{team.name}</div>
                      <div className="text-gray-600">{team.players.join(' & ')}</div>
                    </button>
                  ))}
                </div>
              </div>
            </div>
          </div>
        );
      }

      // SCORING VIEW
      if (view === 'scoring' && currentEvent && selectedTeam) {
        if (!currentEvent.teams || !currentEvent.teams[selectedTeam]) {
          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900 p-6 flex items-center justify-center">
              <div className="bg-white/95 p-8 rounded-2xl text-center">
                <p className="text-gray-900 mb-4">Loading team data...</p>
                <button onClick={() => setView('team-selection')} className="text-blue-600">Go Back</button>
              </div>
            </div>
          );
        }

        const team = currentEvent.teams[selectedTeam];
        const currentHoleNum = team.currentHole;
        const coursePars = currentEvent?.meta?.coursePars || [];
        const currentPar = coursePars[currentHoleNum - 1] || 4;
        const stats = calculateTeamStats(team);
        const isStableford = currentEvent.meta.format === 'stableford';
        
        const roundComplete = stats.holesCompleted >= 18;
        
        if (roundComplete) {
          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900 p-6 flex items-center justify-center">
              <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-8 max-w-md w-full text-center">
                <div className="text-6xl mb-4">🏆</div>
                <h2 className="text-3xl font-bold text-gray-900 mb-2">Round Complete!</h2>
                <p className="text-gray-600 mb-4">{team.name}</p>
                <div className="bg-gray-50 p-4 rounded-xl mb-6">
                  <div className="text-sm text-gray-600 mb-1">{isStableford ? 'Total Points' : 'Final Score'}</div>
                  <div className="text-4xl font-bold text-blue-600 mb-1">{stats.total}</div>
                  {!isStableford && (
                    <div className={`text-lg font-semibold ${stats.toPar > 0 ? 'text-red-600' : stats.toPar < 0 ? 'text-green-600' : 'text-gray-900'}`}>
                      {stats.toPar > 0 ? '+' : ''}{stats.toPar}
                    </div>
                  )}
                </div>
                <div className="space-y-3">
                  <button
                    onClick={() => setView('leaderboard')}
                    className="w-full bg-blue-600 text-white py-4 rounded-xl font-semibold text-lg hover:bg-blue-700 shadow-lg"
                  >
                    View Leaderboard
                  </button>
                  <button
                    onClick={() => setView('scorecard')}
                    className="w-full bg-gray-600 text-white py-3 rounded-xl font-semibold hover:bg-gray-700"
                  >
                    View Scorecard
                  </button>
                  <button
                    onClick={() => setView('team-selection')}
                    className="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-300"
                  >
                    Back to Team Selection
                  </button>
                </div>
              </div>
            </div>
          );
        }
        
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900 p-6 flex flex-col">
            <button onClick={() => setView('team-selection')} className="text-white mb-4 hover:text-blue-200">← Back</button>
            
            <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6 mb-6">
              <div className="text-center mb-4">
                <h2 className="text-2xl font-bold text-gray-900">{currentEvent.meta.name}</h2>
                <div className="text-lg text-gray-600">{team.name}</div>
                <div className="text-sm text-gray-500">{formatNames[currentEvent.meta.format || 'scramble']}</div>
              </div>
              
              <div className="grid grid-cols-3 gap-4 text-center">
                <div>
                  <div className="text-sm text-gray-600">Hole</div>
                  <div className="text-3xl font-bold text-blue-600">{currentHoleNum}</div>
                </div>
                <div>
                  <div className="text-sm text-gray-600">Par</div>
                  <div className="text-3xl font-bold text-gray-900">{currentPar}</div>
                </div>
                <div>
                  <div className="text-sm text-gray-600">{isStableford ? 'Points' : 'Score'}</div>
                  <div className={`text-3xl font-bold ${
                    isStableford ? 'text-blue-600' :
                    stats.toPar > 0 ? 'text-red-600' : 
                    stats.toPar < 0 ? 'text-green-600' : 
                    'text-gray-900'
                  }`}>
                    {isStableford ? stats.total : (stats.toPar > 0 ? '+' : '') + stats.toPar}
                  </div>
                </div>
              </div>
            </div>

            <div className="flex-1 bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6">
              <h3 className="text-xl font-semibold text-gray-900 mb-4 text-center">Enter Score</h3>
              
              {(currentEvent.meta.format === 'bestball' || currentEvent.meta.format === 'shamble') ? (
                <div className="space-y-4 mb-6">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">{team.players[0]}'s Score</label>
                    <div className="grid grid-cols-5 gap-2">
                      {[1,2,3,4,5,6,7,8,9,10].map(score => (
                        <button
                          key={score}
                          onClick={() => {
                            const actualScore = score === 10 ? 10 : score;
                            setPlayerScores({ ...playerScores, player1Score: actualScore });
                          }}
                          className={`py-4 rounded-lg font-bold text-lg transition-all ${
                            playerScores?.player1Score === (score === 10 ? 10 : score)
                              ? 'bg-blue-600 text-white'
                              : score === currentPar
                              ? 'bg-blue-100 text-blue-700 hover:bg-blue-200'
                              : score < currentPar
                              ? 'bg-green-100 text-green-700 hover:bg-green-200'
                              : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                          }`}
                        >
                          {score === 10 ? '10+' : score}
                        </button>
                      ))}
                    </div>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">{team.players[1]}'s Score</label>
                    <div className="grid grid-cols-5 gap-2">
                      {[1,2,3,4,5,6,7,8,9,10].map(score => (
                        <button
                          key={score}
                          onClick={() => {
                            const actualScore = score === 10 ? 10 : score;
                            setPlayerScores({ ...playerScores, player2Score: actualScore });
                          }}
                          className={`py-4 rounded-lg font-bold text-lg transition-all ${
                            playerScores?.player2Score === (score === 10 ? 10 : score)
                              ? 'bg-blue-600 text-white'
                              : score === currentPar
                              ? 'bg-blue-100 text-blue-700 hover:bg-blue-200'
                              : score < currentPar
                              ? 'bg-green-100 text-green-700 hover:bg-green-200'
                              : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                          }`}
                        >
                          {score === 10 ? '10+' : score}
                        </button>
                      ))}
                    </div>
                  </div>
                  
                  {playerScores?.player1Score && playerScores?.player2Score && (
                    <>
                      {currentEvent.meta.format === 'shamble' && !playerScores.driveSelected ? (
                        <div className="bg-purple-50 p-4 rounded-xl">
                          <h4 className="text-sm font-semibold text-gray-700 mb-3 text-center">Whose drive was used?</h4>
                          <div className="grid grid-cols-2 gap-3">
                            <button
                              onClick={() => setPlayerScores({ ...playerScores, driveUsedPlayer: team.players[0], driveSelected: true })}
                              className="bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 font-semibold"
                            >
                              {team.players[0]}'s Drive
                            </button>
                            <button
                              onClick={() => setPlayerScores({ ...playerScores, driveUsedPlayer: team.players[1], driveSelected: true })}
                              className="bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 font-semibold"
                            >
                              {team.players[1]}'s Drive
                            </button>
                          </div>
                        </div>
                      ) : (
                        <button
                          onClick={() => {
                            const bestScore = Math.min(playerScores.player1Score, playerScores.player2Score);
                            const usedPlayer = playerScores.player1Score <= playerScores.player2Score 
                              ? team.players[0] 
                              : team.players[1];
                            const drivePlayer = playerScores.driveUsedPlayer || null;
                            submitScore(bestScore, null, usedPlayer, playerScores.player1Score, playerScores.player2Score, drivePlayer);
                            setPlayerScores(null);
                          }}
                          className="w-full bg-emerald-600 text-white py-4 rounded-xl font-semibold text-lg hover:bg-emerald-700 shadow-lg"
                        >
                          Submit Scores (Best: {Math.min(playerScores.player1Score, playerScores.player2Score)})
                          {playerScores.driveUsedPlayer && (
                            <div className="text-sm opacity-90">Drive: {playerScores.driveUsedPlayer}</div>
                          )}
                        </button>
                      )}
                    </>
                  )}
                </div>
              ) : (
                <div className="grid grid-cols-5 gap-3 mb-6">
                  {[1,2,3,4,5,6,7,8,9,10].map(score => (
                    <button
                      key={score}
                      onClick={() => submitScore(score === 10 ? 10 : score)}
                      className={`py-6 rounded-xl font-bold text-2xl transition-all ${
                        score === currentPar
                          ? 'bg-blue-600 text-white hover:bg-blue-700'
                          : score < currentPar
                          ? 'bg-green-100 text-green-700 hover:bg-green-200'
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      {score === 10 ? '10+' : score}
                    </button>
                  ))}
                </div>
              )}

              {scoreConfirmation && (
                <div className="bg-green-50 border-2 border-green-200 p-4 rounded-xl mb-4">
                  <div className="text-green-800 text-center mb-3">{scoreConfirmation.message}</div>
                  {scoreConfirmation.undoData && (
                    <button
                      onClick={undoScore}
                      className="w-full bg-orange-500 text-white py-2 rounded-lg hover:bg-orange-600 font-semibold flex items-center justify-center gap-2"
                    >
                      <RotateCcw />
                      Undo
                    </button>
                  )}
                </div>
              )}

              <div className="grid grid-cols-2 gap-3">
                <button
                  onClick={() => setView('scorecard')}
                  className="bg-gray-600 text-white py-4 rounded-xl font-semibold hover:bg-gray-700 flex items-center justify-center gap-2"
                >
                  <ClipboardList />
                  Scorecard
                </button>
                <button
                  onClick={() => setView('leaderboard')}
                  className="bg-indigo-600 text-white py-4 rounded-xl font-semibold hover:bg-indigo-700 flex items-center justify-center gap-2"
                >
                  <BarChart />
                  Leaderboard
                </button>
              </div>
            </div>
          </div>
        );
      }

      // SCORECARD VIEW
      if (view === 'scorecard' && currentEvent && selectedTeam) {
        const team = currentEvent.teams[selectedTeam];
        const pars = currentEvent?.meta?.coursePars || Array(18).fill(4);
        const format = currentEvent.meta.format;
        const showPlayerUsed = format === 'bestball' || format === 'shamble';
        const playerUsed = team.playerUsed || {};
        const player1Scores = team.player1Scores || {};
        const player2Scores = team.player2Scores || {};
        const driveUsed = team.driveUsed || {};
        
        const scoresObj = team.scores || {};
        const scoresArray = [];
        for (let i = 0; i < 18; i++) {
          scoresArray[i] = scoresObj[i] === -1 ? null : scoresObj[i];
        }
        
        const front9Total = scoresArray.slice(0, 9).reduce((sum, s) => sum + (s || 0), 0);
        const back9Total = scoresArray.slice(9, 18).reduce((sum, s) => sum + (s || 0), 0);
        const front9Par = pars.slice(0, 9).reduce((sum, p) => sum + p, 0);
        const back9Par = pars.slice(9, 18).reduce((sum, p) => sum + p, 0);
        
        const getInitials = (name) => {
          return name?.split(' ').map(n => n[0]).join('').toUpperCase() || '?';
        };

        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900 p-6">
            <div className="max-w-2xl mx-auto">
              <button onClick={() => setView('scoring')} className="text-white mb-6 hover:text-blue-200">← Back to Scoring</button>
              
              <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-8">
                <h2 className="text-2xl font-bold text-gray-900 mb-2 text-center">{team.name}</h2>
                <p className="text-gray-600 mb-6 text-center">Scorecard</p>
                
                <div className="mb-6">
                  <h3 className="text-sm font-semibold text-gray-700 mb-3">Front 9</h3>
                  <div className="grid grid-cols-9 gap-1 mb-2">
                    {pars.slice(0, 9).map((par, idx) => {
                      const playerName = showPlayerUsed ? playerUsed[idx] : null;
                      const p1Score = player1Scores[idx];
                      const p2Score = player2Scores[idx];
                      const showBothScores = showPlayerUsed && p1Score && p2Score;
                      const drive = format === 'shamble' ? driveUsed[idx] : null;
                      
                      return (
                        <button
                          key={idx}
                          onClick={() => setEditingHole(idx + 1)}
                          className="bg-gray-50 hover:bg-blue-50 p-2 rounded text-center cursor-pointer"
                        >
                          <div className="text-xs text-gray-500">#{idx + 1}</div>
                          <div className="text-xs text-gray-400">Par {par}</div>
                          <div className={`font-bold ${
                            scoresArray[idx] === null ? 'text-gray-300' :
                            scoresArray[idx] < par ? 'text-green-600' :
                            scoresArray[idx] > par ? 'text-red-600' :
                            'text-gray-900'
                          }`}>
                            {scoresArray[idx] || '-'}
                          </div>
                          {showBothScores && (
                            <div className="text-xs text-gray-600 mt-1">
                              <div className={p1Score === scoresArray[idx] ? 'font-bold text-blue-600' : ''}>{p1Score}</div>
                              <div className={p2Score === scoresArray[idx] ? 'font-bold text-blue-600' : ''}>{p2Score}</div>
                            </div>
                          )}
                          {drive && (
                            <div className="text-xs text-purple-600 font-semibold">D:{getInitials(drive)}</div>
                          )}
                        </button>
                      );
                    })}
                  </div>
                  <div className="text-right text-sm font-semibold">
                    Total: {front9Total} ({front9Total - front9Par > 0 ? '+' : ''}{front9Total - front9Par})
                  </div>
                </div>

                <div className="mb-6">
                  <h3 className="text-sm font-semibold text-gray-700 mb-3">Back 9</h3>
                  <div className="grid grid-cols-9 gap-1 mb-2">
                    {pars.slice(9, 18).map((par, idx) => {
                      const holeNum = idx + 10;
                      const holeIdx = idx + 9;
                      const playerName = showPlayerUsed ? playerUsed[holeIdx] : null;
                      const p1Score = player1Scores[holeIdx];
                      const p2Score = player2Scores[holeIdx];
                      const showBothScores = showPlayerUsed && p1Score && p2Score;
                      const drive = format === 'shamble' ? driveUsed[holeIdx] : null;
                      
                      return (
                        <button
                          key={holeIdx}
                          onClick={() => setEditingHole(holeNum)}
                          className="bg-gray-50 hover:bg-blue-50 p-2 rounded text-center cursor-pointer"
                        >
                          <div className="text-xs text-gray-500">#{holeNum}</div>
                          <div className="text-xs text-gray-400">Par {par}</div>
                          <div className={`font-bold ${
                            scoresArray[holeIdx] === null ? 'text-gray-300' :
                            scoresArray[holeIdx] < par ? 'text-green-600' :
                            scoresArray[holeIdx] > par ? 'text-red-600' :
                            'text-gray-900'
                          }`}>
                            {scoresArray[holeIdx] || '-'}
                          </div>
                          {showBothScores && (
                            <div className="text-xs text-gray-600 mt-1">
                              <div className={p1Score === scoresArray[holeIdx] ? 'font-bold text-blue-600' : ''}>{p1Score}</div>
                              <div className={p2Score === scoresArray[holeIdx] ? 'font-bold text-blue-600' : ''}>{p2Score}</div>
                            </div>
                          )}
                          {drive && (
                            <div className="text-xs text-purple-600 font-semibold">D:{getInitials(drive)}</div>
                          )}
                        </button>
                      );
                    })}
                  </div>
                  <div className="text-right text-sm font-semibold">
                    Total: {back9Total} ({back9Total - back9Par > 0 ? '+' : ''}{back9Total - back9Par})
                  </div>
                </div>

                <div className="bg-blue-50 p-4 rounded-xl mb-4">
                  <div className="flex justify-between items-center">
                    <span className="font-semibold text-gray-900">Total Score</span>
                    <span className="text-2xl font-bold text-blue-600">
                      {front9Total + back9Total} ({(front9Total + back9Total) - (front9Par + back9Par) > 0 ? '+' : ''}{(front9Total + back9Total) - (front9Par + back9Par)})
                    </span>
                  </div>
                </div>
                
                {showPlayerUsed && (
                  <div className="bg-gray-50 p-4 rounded-xl">
                    <h3 className="text-sm font-semibold text-gray-700 mb-2">Player Usage</h3>
                    <div className="grid grid-cols-2 gap-3">
                      {team.players.map(player => {
                        const holesUsed = Object.values(playerUsed).filter(p => p === player).length;
                        const drivesUsed = format === 'shamble' ? Object.values(driveUsed).filter(p => p === player).length : null;
                        return (
                          <div key={player} className="text-center">
                            <div className="text-lg font-bold text-gray-900">{player}</div>
                            <div className="text-sm text-gray-600">{holesUsed} hole{holesUsed !== 1 ? 's' : ''}</div>
                            {drivesUsed !== null && (
                              <div className="text-xs text-purple-600">{drivesUsed} drive{drivesUsed !== 1 ? 's' : ''}</div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}
              </div>
            </div>

            {editingHole && (
              <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
                  <h3 className="text-xl font-bold text-gray-900 mb-2">Edit Hole {editingHole}</h3>
                  <p className="text-gray-600 mb-4">
                    Par {pars[editingHole - 1]} - Current: {scoresArray[editingHole - 1] || 'Not recorded'}
                  </p>
                  
                  <div className="grid grid-cols-5 gap-2 mb-4">
                    {[1,2,3,4,5,6,7,8,9,10].map(score => (
                      <button
                        key={score}
                        onClick={() => {
                          submitScore(score === 10 ? 10 : score, editingHole);
                          setEditingHole(null);
                        }}
                        className="py-4 rounded-lg font-bold text-lg bg-gray-100 hover:bg-blue-100 text-gray-900"
                      >
                        {score === 10 ? '10+' : score}
                      </button>
                    ))}
                  </div>
                  
                  <button
                    onClick={() => setEditingHole(null)}
                    className="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-300"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            )}
          </div>
        );
      }

      // LEADERBOARD VIEW
      if (view === 'leaderboard' && currentEvent) {
        const format = currentEvent.meta.format || 'scramble';
        const isStableford = format === 'stableford';
        
        const teams = Object.entries(currentEvent.teams || {}).map(([teamId, team]) => ({
          teamId,
          ...team,
          stats: calculateTeamStats(team)
        }));

        teams.sort((a, b) => isStableford ? b.stats.total - a.stats.total : a.stats.total - b.stats.total);
        
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900 p-6">
            <div className="max-w-2xl mx-auto">
              <button onClick={() => setView('scoring')} className="text-white mb-6 hover:text-blue-200">← Back to Scoring</button>
              
              <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-8">
                <div className="text-center mb-8">
                  <div className="inline-block bg-blue-600 p-3 rounded-xl mb-4">
                    <Trophy />
                  </div>
                  <h2 className="text-3xl font-bold text-gray-900 mb-2">Leaderboard</h2>
                  <p className="text-gray-600">{currentEvent.meta.name}</p>
                  <p className="text-sm text-gray-500">{formatNames[format]}</p>
                </div>

                <div className="space-y-3 mb-8">
                  {teams.map((team, index) => {
                    const isExpanded = expandedTeams.includes(team.teamId);
                    
                    return (
                      <div key={team.teamId}>
                        <button
                          onClick={() => toggleTeamExpansion(team.teamId)}
                          className={`w-full p-5 rounded-xl ${
                            index === 0
                              ? 'bg-gradient-to-r from-yellow-400 to-yellow-500'
                              : index === 1
                              ? 'bg-gradient-to-r from-gray-300 to-gray-400'
                              : index === 2
                              ? 'bg-gradient-to-r from-orange-400 to-orange-500'
                              : 'bg-gray-50'
                          }`}
                        >
                          <div className="flex items-center justify-between">
                            <div className="flex items-center gap-4">
                              <div className={`text-2xl font-bold ${index < 3 ? 'text-white' : 'text-gray-900'}`}>
                                #{index + 1}
                              </div>
                              <div className="text-left">
                                <div className={`font-bold text-lg ${index < 3 ? 'text-white' : 'text-gray-900'}`}>
                                  {team.name}
                                </div>
                                <div className={`text-sm ${index < 3 ? 'text-white/80' : 'text-gray-600'}`}>
                                  Thru {team.stats.holesCompleted}
                                </div>
                              </div>
                            </div>
                            <div className="flex items-center gap-4">
                              <div className="text-right">
                                <div className={`text-3xl font-bold ${index < 3 ? 'text-white' : 'text-gray-900'}`}>
                                  {team.stats.total}
                                </div>
                                {!isStableford && (
                                  <div className={`text-sm font-semibold ${
                                    team.stats.toPar > 0 
                                      ? (index < 3 ? 'text-white/80' : 'text-red-600')
                                      : team.stats.toPar < 0
                                      ? (index < 3 ? 'text-white/80' : 'text-green-600')
                                      : (index < 3 ? 'text-white/80' : 'text-gray-600')
                                  }`}>
                                    {team.stats.toPar > 0 ? '+' : ''}{team.stats.toPar}
                                  </div>
                                )}
                                {isStableford && (
                                  <div className={`text-sm font-semibold ${index < 3 ? 'text-white/80' : 'text-gray-600'}`}>
                                    points
                                  </div>
                                )}
                              </div>
                              <div className={index < 3 ? 'text-white' : 'text-gray-600'}>
                                {isExpanded ? <ChevronUp /> : <ChevronDown />}
                              </div>
                            </div>
                          </div>
                        </button>
                        
                        {isExpanded && (
                          <div className="bg-white p-4 rounded-b-xl -mt-2 border-2 border-gray-200">
                            <div className="text-xs font-semibold text-gray-600 mb-2">Hole-by-Hole</div>
                            <div className="grid grid-cols-9 gap-1 mb-3">
                              {Object.entries(team.scores || {}).map(([holeIdx, score]) => {
                                const idx = parseInt(holeIdx);
                                const coursePars = currentEvent?.meta?.coursePars || [];
                                const par = coursePars[idx] || 4;
                                const displayScore = score === -1 ? null : score;
                                return (
                                  <div key={idx} className="text-center">
                                    <div className="text-xs text-gray-400">#{idx + 1}</div>
                                    <div className={`font-bold text-sm ${
                                      displayScore === null ? 'text-gray-300' :
                                      displayScore < par ? 'text-green-600' :
                                      displayScore > par ? 'text-red-600' :
                                      'text-gray-900'
                                    }`}>
                                      {displayScore || '-'}
                                    </div>
                                  </div>
                                );
                              })}
                            </div>
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                setViewingTeamScorecard(team.teamId);
                              }}
                              className="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 font-semibold text-sm"
                            >
                              View Full Scorecard
                            </button>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>

                <div className="bg-gray-50 p-4 rounded-xl text-center">
                  <div className="text-xs text-gray-600 mb-2">Share this code with other groups</div>
                  <div className="flex items-center justify-center gap-3">
                    <div className="font-mono font-bold text-blue-600 text-xl">{currentEvent.meta.eventCode}</div>
                    <button
                      onClick={copyEventCode}
                      className="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700"
                    >
                      <Copy />
                    </button>
                  </div>
                  {feedback && <div className="text-sm text-green-600 mt-2">{feedback}</div>}
                </div>
              </div>
            </div>
          </div>
        );
      }

      // TEAM SCORECARD VIEWER (for viewing other teams' scorecards from leaderboard)
      if (viewingTeamScorecard && currentEvent) {
        const team = currentEvent.teams[viewingTeamScorecard];
        if (!team) {
          setViewingTeamScorecard(null);
          return null;
        }
        
        const pars = currentEvent?.meta?.coursePars || Array(18).fill(4);
        const format = currentEvent.meta.format;
        const showPlayerUsed = format === 'bestball' || format === 'shamble';
        const playerUsed = team.playerUsed || {};
        const player1Scores = team.player1Scores || {};
        const player2Scores = team.player2Scores || {};
        const driveUsed = team.driveUsed || {};
        
        const scoresObj = team.scores || {};
        const scoresArray = [];
        for (let i = 0; i < 18; i++) {
          scoresArray[i] = scoresObj[i] === -1 ? null : scoresObj[i];
        }
        
        const front9Total = scoresArray.slice(0, 9).reduce((sum, s) => sum + (s || 0), 0);
        const back9Total = scoresArray.slice(9, 18).reduce((sum, s) => sum + (s || 0), 0);
        const front9Par = pars.slice(0, 9).reduce((sum, p) => sum + p, 0);
        const back9Par = pars.slice(9, 18).reduce((sum, p) => sum + p, 0);
        
        const getInitials = (name) => {
          return name?.split(' ').map(n => n[0]).join('').toUpperCase() || '?';
        };
        
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900 p-6">
            <div className="max-w-2xl mx-auto">
              <button onClick={() => setViewingTeamScorecard(null)} className="text-white mb-6 hover:text-blue-200">← Back to Leaderboard</button>
              
              <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-8">
                <h2 className="text-2xl font-bold text-gray-900 mb-2 text-center">{team.name}</h2>
                <p className="text-gray-600 mb-6 text-center">Scorecard</p>
                
                <div className="mb-6">
                  <h3 className="text-sm font-semibold text-gray-700 mb-3">Front 9</h3>
                  <div className="grid grid-cols-9 gap-1 mb-2">
                    {pars.slice(0, 9).map((par, idx) => {
                      const playerName = showPlayerUsed ? playerUsed[idx] : null;
                      const p1Score = player1Scores[idx];
                      const p2Score = player2Scores[idx];
                      const showBothScores = showPlayerUsed && p1Score && p2Score;
                      const drive = format === 'shamble' ? driveUsed[idx] : null;
                      
                      return (
                        <div key={idx} className="bg-gray-50 p-2 rounded text-center">
                          <div className="text-xs text-gray-500">#{idx + 1}</div>
                          <div className="text-xs text-gray-400">Par {par}</div>
                          <div className={`font-bold ${
                            scoresArray[idx] === null ? 'text-gray-300' :
                            scoresArray[idx] < par ? 'text-green-600' :
                            scoresArray[idx] > par ? 'text-red-600' :
                            'text-gray-900'
                          }`}>
                            {scoresArray[idx] || '-'}
                          </div>
                          {showBothScores && (
                            <div className="text-xs text-gray-600 mt-1">
                              <div className={p1Score === scoresArray[idx] ? 'font-bold text-blue-600' : ''}>{p1Score}</div>
                              <div className={p2Score === scoresArray[idx] ? 'font-bold text-blue-600' : ''}>{p2Score}</div>
                            </div>
                          )}
                          {drive && (
                            <div className="text-xs text-purple-600 font-semibold">D:{getInitials(drive)}</div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                  <div className="text-right text-sm font-semibold">
                    Total: {front9Total} ({front9Total - front9Par > 0 ? '+' : ''}{front9Total - front9Par})
                  </div>
                </div>

                <div className="mb-6">
                  <h3 className="text-sm font-semibold text-gray-700 mb-3">Back 9</h3>
                  <div className="grid grid-cols-9 gap-1 mb-2">
                    {pars.slice(9, 18).map((par, idx) => {
                      const holeNum = idx + 10;
                      const holeIdx = idx + 9;
                      const playerName = showPlayerUsed ? playerUsed[holeIdx] : null;
                      const p1Score = player1Scores[holeIdx];
                      const p2Score = player2Scores[holeIdx];
                      const showBothScores = showPlayerUsed && p1Score && p2Score;
                      const drive = format === 'shamble' ? driveUsed[holeIdx] : null;
                      
                      return (
                        <div key={holeIdx} className="bg-gray-50 p-2 rounded text-center">
                          <div className="text-xs text-gray-500">#{holeNum}</div>
                          <div className="text-xs text-gray-400">Par {par}</div>
                          <div className={`font-bold ${
                            scoresArray[holeIdx] === null ? 'text-gray-300' :
                            scoresArray[holeIdx] < par ? 'text-green-600' :
                            scoresArray[holeIdx] > par ? 'text-red-600' :
                            'text-gray-900'
                          }`}>
                            {scoresArray[holeIdx] || '-'}
                          </div>
                          {showBothScores && (
                            <div className="text-xs text-gray-600 mt-1">
                              <div className={p1Score === scoresArray[holeIdx] ? 'font-bold text-blue-600' : ''}>{p1Score}</div>
                              <div className={p2Score === scoresArray[holeIdx] ? 'font-bold text-blue-600' : ''}>{p2Score}</div>
                            </div>
                          )}
                          {drive && (
                            <div className="text-xs text-purple-600 font-semibold">D:{getInitials(drive)}</div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                  <div className="text-right text-sm font-semibold">
                    Total: {back9Total} ({back9Total - back9Par > 0 ? '+' : ''}{back9Total - back9Par})
                  </div>
                </div>

                <div className="bg-blue-50 p-4 rounded-xl mb-4">
                  <div className="flex justify-between items-center">
                    <span className="font-semibold text-gray-900">Total Score</span>
                    <span className="text-2xl font-bold text-blue-600">
                      {front9Total + back9Total} ({(front9Total + back9Total) - (front9Par + back9Par) > 0 ? '+' : ''}{(front9Total + back9Total) - (front9Par + back9Par)})
                    </span>
                  </div>
                </div>
                
                {showPlayerUsed && (
                  <div className="bg-gray-50 p-4 rounded-xl">
                    <h3 className="text-sm font-semibold text-gray-700 mb-2">Player Usage</h3>
                    <div className="grid grid-cols-2 gap-3">
                      {team.players.map(player => {
                        const holesUsed = Object.values(playerUsed).filter(p => p === player).length;
                        const drivesUsed = format === 'shamble' ? Object.values(driveUsed).filter(p => p === player).length : null;
                        return (
                          <div key={player} className="text-center">
                            <div className="text-lg font-bold text-gray-900">{player}</div>
                            <div className="text-sm text-gray-600">{holesUsed} hole{holesUsed !== 1 ? 's' : ''}</div>
                            {drivesUsed !== null && (
                              <div className="text-xs text-purple-600">{drivesUsed} drive{drivesUsed !== 1 ? 's' : ''}</div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      }

      // MANAGE COURSES VIEW
      if (view === 'manage-courses') {
        if (!isAdmin()) {
          setView('home');
          return null;
        }

        const deleteCourse = async (courseId, courseName) => {
          if (!confirm(`Delete ${courseName}? This cannot be undone.`)) return;
          
          try {
            await database.ref(`courses/${courseId}`).remove();
            setFeedback('Course deleted');
            setTimeout(() => setFeedback(''), 2000);
            await loadCourses();
          } catch (error) {
            console.error('Error deleting course:', error);
            setFeedback('Error deleting course');
          }
        };

        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900 p-6">
            <div className="max-w-4xl mx-auto">
              <button onClick={() => setView('home')} className="text-white mb-6 hover:text-blue-200">← Back</button>
              
              <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-8">
                <h2 className="text-3xl font-bold text-gray-900 mb-6">Manage Courses</h2>

                {feedback && (
                  <div className={`mb-4 p-3 rounded-lg text-sm ${
                    feedback.includes('Error') ? 'bg-red-50 border-2 border-red-200 text-red-800' : 'bg-green-50 border-2 border-green-200 text-green-800'
                  }`}>
                    {feedback}
                  </div>
                )}

                {globalCourses.length > 0 ? (
                  <div className="space-y-3 mb-6">
                    {globalCourses.map(course => {
                      const teeCount = Object.keys(course.tees || {}).length;
                      const firstTee = Object.values(course.tees || {})[0];
                      const totalPar = firstTee?.pars?.reduce((sum, p) => sum + parseInt(p || 0), 0) || 0;
                      
                      return (
                        <div key={course.id} className="bg-gray-50 p-4 rounded-xl flex items-start justify-between">
                          <div>
                            <div className="font-bold text-lg text-gray-900">{course.name}</div>
                            <div className="text-sm text-gray-600">
                              {course.location} · {teeCount} tee{teeCount !== 1 ? 's' : ''} · Par {totalPar}
                            </div>
                          </div>
                          <div className="flex gap-2">
                            <button
                              onClick={() => {
                                setEditingCourse(course);
                                setCourseForm({
                                  name: course.name,
                                  location: course.location,
                                  strokeIndex: course.strokeIndex || Array(18).fill(''),
                                  tees: Object.entries(course.tees || {}).map(([id, tee]) => ({
                                    id,
                                    name: tee.name,
                                    rating: tee.rating,
                                    slope: tee.slope,
                                    pars: tee.pars || Array(18).fill(''),
                                    yardages: tee.yardages || Array(18).fill('')
                                  }))
                                });
                                setView('edit-course');
                              }}
                              className="text-sm bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 font-semibold"
                            >
                              Edit
                            </button>
                            <button
                              onClick={() => deleteCourse(course.id, course.name)}
                              className="text-sm bg-red-600 text-white px-3 py-1 rounded-lg hover:bg-red-700 font-semibold"
                            >
                              Delete
                            </button>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                ) : (
                  <p className="text-center text-gray-600 py-8 mb-6">No courses yet. Add your first course!</p>
                )}

                <button
                  onClick={() => {
                    setEditingCourse(null);
                    setCourseForm({
                      name: '',
                      location: '',
                      strokeIndex: Array(18).fill(''),
                      tees: [{
                        id: 'tee-1',
                        name: '',
                        rating: '',
                        slope: '',
                        pars: Array(18).fill(''),
                        yardages: Array(18).fill('')
                      }]
                    });
                    setView('edit-course');
                  }}
                  className="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-blue-700"
                >
                  + Add Course
                </button>
              </div>
            </div>
          </div>
        );
      }

      // EDIT COURSE VIEW
      if (view === 'edit-course') {
        if (!isAdmin()) {
          setView('home');
          return null;
        }

        const addTee = () => {
          const newTeeId = `tee-${courseForm.tees.length + 1}`;
          setCourseForm({
            ...courseForm,
            tees: [...courseForm.tees, {
              id: newTeeId,
              name: '',
              rating: '',
              slope: '',
              pars: Array(18).fill(''),
              yardages: Array(18).fill('')
            }]
          });
        };

        const removeTee = (index) => {
          if (courseForm.tees.length === 1) {
            setFeedback('Must have at least 1 tee');
            setTimeout(() => setFeedback(''), 2000);
            return;
          }
          const newTees = courseForm.tees.filter((_, i) => i !== index);
          setCourseForm({ ...courseForm, tees: newTees });
        };

        const updateTeeField = (index, field, value) => {
          const newTees = [...courseForm.tees];
          newTees[index] = { ...newTees[index], [field]: value };
          setCourseForm({ ...courseForm, tees: newTees });
        };

        const updateTeeHole = (teeIndex, holeIndex, field, value) => {
          const newTees = [...courseForm.tees];
          const newArray = [...newTees[teeIndex][field]];
          newArray[holeIndex] = value;
          newTees[teeIndex] = { ...newTees[teeIndex], [field]: newArray };
          setCourseForm({ ...courseForm, tees: newTees });
        };

        const updateStrokeIndex = (holeIndex, value) => {
          const newSI = [...courseForm.strokeIndex];
          newSI[holeIndex] = value;
          setCourseForm({ ...courseForm, strokeIndex: newSI });
        };

        const saveCourse = async () => {
          // Validation
          if (!courseForm.name.trim()) {
            setFeedback('Course name is required');
            setTimeout(() => setFeedback(''), 2000);
            return;
          }

          if (courseForm.tees.length === 0) {
            setFeedback('Must have at least 1 tee');
            setTimeout(() => setFeedback(''), 2000);
            return;
          }

          // Validate each tee has all pars filled
          for (let i = 0; i < courseForm.tees.length; i++) {
            const tee = courseForm.tees[i];
            if (!tee.name.trim()) {
              setFeedback(`Tee ${i + 1}: Name is required`);
              setTimeout(() => setFeedback(''), 2000);
              return;
            }
            const emptyPars = tee.pars.filter(p => !p || p === '').length;
            if (emptyPars > 0) {
              setFeedback(`${tee.name}: All 18 pars must be filled`);
              setTimeout(() => setFeedback(''), 2000);
              return;
            }
          }

          // Validate stroke index
          const emptySI = courseForm.strokeIndex.filter(si => !si || si === '').length;
          if (emptySI > 0) {
            setFeedback('All 18 stroke indexes must be filled');
            setTimeout(() => setFeedback(''), 2000);
            return;
          }
          
          // Validate stroke index values are 1-18 and unique
          const siValues = courseForm.strokeIndex.map(si => parseInt(si));
          const siSet = new Set(siValues);
          if (siSet.size !== 18) {
            setFeedback('Stroke indexes must be unique values from 1 to 18');
            setTimeout(() => setFeedback(''), 2000);
            return;
          }
          for (let i = 1; i <= 18; i++) {
            if (!siSet.has(i)) {
              setFeedback(`Stroke index ${i} is missing. Each value from 1-18 must be used exactly once.`);
              setTimeout(() => setFeedback(''), 2000);
              return;
            }
          }

          try {
            const courseId = editingCourse?.id || `course-${Date.now()}`;
            
            const teeData = {};
            courseForm.tees.forEach(tee => {
              teeData[tee.id] = {
                name: tee.name,
                rating: parseFloat(tee.rating) || 0,
                slope: parseInt(tee.slope) || 0,
                pars: tee.pars.map(p => parseInt(p) || 0),
                yardages: tee.yardages.map(y => parseInt(y) || 0)
              };
            });

            const courseData = {
              name: courseForm.name,
              location: courseForm.location,
              strokeIndex: courseForm.strokeIndex.map(si => parseInt(si) || 0),
              tees: teeData,
              createdBy: currentUser.uid,
              createdAt: editingCourse?.createdAt || Date.now()
            };

            await database.ref(`courses/${courseId}`).set(courseData);
            
            setFeedback('Course saved!');
            setTimeout(async () => {
              await loadCourses();
              setView('manage-courses');
              setFeedback('');
            }, 1500);

          } catch (error) {
            console.error('Error saving course:', error);
            setFeedback('Error saving course');
          }
        };

        const calculateTotal = (array, start, end) => {
          return array.slice(start, end).reduce((sum, val) => sum + (parseInt(val) || 0), 0);
        };

        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900 p-6">
            <div className="max-w-6xl mx-auto">
              <button onClick={() => { setView('manage-courses'); setEditingCourse(null); }} className="text-white mb-6 hover:text-blue-200">← Back</button>
              
              <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-8">
                <h2 className="text-3xl font-bold text-gray-900 mb-6">
                  {editingCourse ? 'Edit Course' : 'Add Course'}
                </h2>

                {feedback && (
                  <div className={`mb-4 p-3 rounded-lg text-sm ${
                    feedback.includes('Error') || feedback.includes('required') || feedback.includes('must')
                      ? 'bg-red-50 border-2 border-red-200 text-red-800'
                      : 'bg-green-50 border-2 border-green-200 text-green-800'
                  }`}>
                    {feedback}
                  </div>
                )}

                {/* Basic Info */}
                <div className="mb-6">
                  <h3 className="text-lg font-bold text-gray-900 mb-4">Basic Information</h3>
                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Course Name</label>
                      <input
                        type="text"
                        value={courseForm.name}
                        onChange={(e) => setCourseForm({ ...courseForm, name: e.target.value })}
                        className="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none"
                        placeholder="Glen Eagle Golf Course"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Location</label>
                      <input
                        type="text"
                        value={courseForm.location}
                        onChange={(e) => setCourseForm({ ...courseForm, location: e.target.value })}
                        className="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none"
                        placeholder="Syracuse, UT"
                      />
                    </div>
                  </div>
                </div>

                {/* Tees */}
                <div className="mb-6">
                  <h3 className="text-lg font-bold text-gray-900 mb-4">Tees</h3>
                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse">
                      <thead>
                        <tr className="border-b-2 border-gray-300">
                          <th className="text-left p-2 text-sm font-semibold text-gray-700">Tee Name</th>
                          <th className="text-left p-2 text-sm font-semibold text-gray-700">Rating</th>
                          <th className="text-left p-2 text-sm font-semibold text-gray-700">Slope</th>
                          <th className="w-12"></th>
                        </tr>
                      </thead>
                      <tbody>
                        {courseForm.tees.map((tee, index) => (
                          <tr key={tee.id} className="border-b border-gray-200">
                            <td className="p-2">
                              <input
                                type="text"
                                value={tee.name}
                                onChange={(e) => updateTeeField(index, 'name', e.target.value)}
                                className="w-full px-3 py-2 rounded-lg border-2 border-gray-200 focus:border-blue-500 focus:outline-none"
                                placeholder="Black"
                              />
                            </td>
                            <td className="p-2">
                              <input
                                type="number"
                                step="0.1"
                                value={tee.rating}
                                onChange={(e) => updateTeeField(index, 'rating', e.target.value)}
                                className="w-full px-3 py-2 rounded-lg border-2 border-gray-200 focus:border-blue-500 focus:outline-none"
                                placeholder="72.1"
                              />
                            </td>
                            <td className="p-2">
                              <input
                                type="number"
                                value={tee.slope}
                                onChange={(e) => updateTeeField(index, 'slope', e.target.value)}
                                className="w-full px-3 py-2 rounded-lg border-2 border-gray-200 focus:border-blue-500 focus:outline-none"
                                placeholder="131"
                              />
                            </td>
                            <td className="p-2">
                              <button
                                onClick={() => removeTee(index)}
                                className="text-red-600 hover:text-red-700 p-1"
                                title="Delete tee"
                              >
                                <Trash />
                              </button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                  <button
                    onClick={addTee}
                    className="mt-3 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 font-semibold text-sm"
                  >
                    + Add Tee
                  </button>
                </div>

                {/* Hole Details - Organized by Tee */}
                <div className="mb-6">
                  <h3 className="text-lg font-bold text-gray-900 mb-4">Hole Details</h3>
                  
                  {/* Stroke Index - Shared across all tees */}
                  <div className="mb-6 bg-gray-50 p-4 rounded-xl">
                    <h4 className="text-sm font-bold text-gray-900 mb-3">Stroke Index (Shared - All 18 Holes)</h4>
                    <div className="overflow-x-auto">
                      <table className="w-full border-collapse text-xs">
                        <thead>
                          <tr className="border-b-2 border-gray-300">
                            <th className="p-1 text-left min-w-[60px]"></th>
                            {[1,2,3,4,5,6,7,8,9].map(h => (
                              <th key={h} className="p-1 text-center w-16">{h}</th>
                            ))}
                            <th className="p-1 text-center w-16"></th>
                            {[10,11,12,13,14,15,16,17,18].map(h => (
                              <th key={h} className="p-1 text-center w-16">{h}</th>
                            ))}
                          </tr>
                        </thead>
                        <tbody>
                          <tr className="border-b border-gray-200">
                            <td className="p-1 font-semibold">SI</td>
                            {[...Array(18)].map((_, i) => (
                              <React.Fragment key={i}>
                                <td className="p-1">
                                  <input
                                    type="text"
                                    inputMode="numeric"
                                    pattern="[0-9]*"
                                    value={courseForm.strokeIndex[i]}
                                    onChange={(e) => updateStrokeIndex(i, e.target.value)}
                                    className="w-full px-1 py-1 text-center rounded border border-gray-300 focus:border-blue-500 focus:outline-none [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
                                  />
                                </td>
                                {i === 8 && <td className="p-1 bg-gray-200"></td>}
                              </React.Fragment>
                            ))}
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>

                  {/* Par - Shared across all tees */}
                  <div className="mb-6 bg-gray-50 p-4 rounded-xl">
                    <h4 className="text-sm font-bold text-gray-900 mb-3">Par (Shared - All 18 Holes)</h4>
                    <div className="overflow-x-auto">
                      <table className="w-full border-collapse text-xs">
                        <thead>
                          <tr className="border-b-2 border-gray-300">
                            <th className="p-1 text-left min-w-[60px]"></th>
                            {[1,2,3,4,5,6,7,8,9].map(h => (
                              <th key={h} className="p-1 text-center w-16">{h}</th>
                            ))}
                            <th className="p-1 text-center w-16 font-bold">OUT</th>
                            {[10,11,12,13,14,15,16,17,18].map(h => (
                              <th key={h} className="p-1 text-center w-16">{h}</th>
                            ))}
                            <th className="p-1 text-center w-16 font-bold">IN</th>
                            <th className="p-1 text-center w-16 font-bold">TOT</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr className="border-b border-gray-200">
                            <td className="p-1 font-semibold">Par</td>
                            {[...Array(18)].map((_, i) => (
                              <React.Fragment key={i}>
                                <td className="p-1">
                                  <input
                                    type="text"
                                    inputMode="numeric"
                                    pattern="[0-9]*"
                                    value={courseForm.tees[0]?.pars[i] || ''}
                                    onChange={(e) => {
                                      // Update par for ALL tees
                                      const newTees = courseForm.tees.map(tee => ({
                                        ...tee,
                                        pars: tee.pars.map((p, idx) => idx === i ? e.target.value : p)
                                      }));
                                      setCourseForm({ ...courseForm, tees: newTees });
                                    }}
                                    className="w-full px-1 py-1 text-center rounded border border-gray-300 focus:border-blue-500 focus:outline-none [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
                                  />
                                </td>
                                {i === 8 && (
                                  <td className="p-1 text-center font-bold bg-gray-200">
                                    {calculateTotal(courseForm.tees[0]?.pars || [], 0, 9)}
                                  </td>
                                )}
                              </React.Fragment>
                            ))}
                            <td className="p-1 text-center font-bold bg-gray-200">
                              {calculateTotal(courseForm.tees[0]?.pars || [], 9, 18)}
                            </td>
                            <td className="p-1 text-center font-bold bg-gray-200">
                              {calculateTotal(courseForm.tees[0]?.pars || [], 0, 18)}
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>

                  {/* Yardages by Tee */}
                  {courseForm.tees.map((tee, teeIndex) => (
                    <div key={tee.id} className="mb-6 border-2 border-gray-200 rounded-xl p-4">
                      <h4 className="text-md font-bold text-gray-900 mb-3">
                        {tee.name || `Tee ${teeIndex + 1}`} - Yardages
                      </h4>
                      
                      {/* Front 9 */}
                      <div className="mb-4">
                        <h5 className="text-sm font-semibold text-gray-700 mb-2">Front 9</h5>
                        <div className="overflow-x-auto">
                          <table className="w-full border-collapse text-xs">
                            <thead>
                              <tr className="border-b-2 border-gray-300">
                                <th className="p-1 text-left min-w-[60px]"></th>
                                {[1,2,3,4,5,6,7,8,9].map(h => (
                                  <th key={h} className="p-1 text-center w-16">{h}</th>
                                ))}
                                <th className="p-1 text-center w-16 font-bold">OUT</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr className="border-b border-gray-200">
                                <td className="p-1 text-gray-600">Yds</td>
                                {[...Array(9)].map((_, i) => (
                                  <td key={i} className="p-1">
                                    <input
                                      type="text"
                                      inputMode="numeric"
                                      pattern="[0-9]*"
                                      value={tee.yardages[i]}
                                      onChange={(e) => updateTeeHole(teeIndex, i, 'yardages', e.target.value)}
                                      className="w-full px-1 py-1 text-center rounded border border-gray-300 focus:border-blue-500 focus:outline-none [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
                                    />
                                  </td>
                                ))}
                                <td className="p-1 text-center font-bold">{calculateTotal(tee.yardages, 0, 9)}</td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                      </div>

                      {/* Back 9 */}
                      <div>
                        <h5 className="text-sm font-semibold text-gray-700 mb-2">Back 9</h5>
                        <div className="overflow-x-auto">
                          <table className="w-full border-collapse text-xs">
                            <thead>
                              <tr className="border-b-2 border-gray-300">
                                <th className="p-1 text-left min-w-[60px]"></th>
                                {[10,11,12,13,14,15,16,17,18].map(h => (
                                  <th key={h} className="p-1 text-center w-16">{h}</th>
                                ))}
                                <th className="p-1 text-center w-16 font-bold">IN</th>
                                <th className="p-1 text-center w-16 font-bold">TOT</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr className="border-b border-gray-200">
                                <td className="p-1 text-gray-600">Yds</td>
                                {[...Array(9)].map((_, i) => (
                                  <td key={i} className="p-1">
                                    <input
                                      type="text"
                                      inputMode="numeric"
                                      pattern="[0-9]*"
                                      value={tee.yardages[i + 9]}
                                      onChange={(e) => updateTeeHole(teeIndex, i + 9, 'yardages', e.target.value)}
                                      className="w-full px-1 py-1 text-center rounded border border-gray-300 focus:border-blue-500 focus:outline-none [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
                                    />
                                  </td>
                                ))}
                                <td className="p-1 text-center font-bold">{calculateTotal(tee.yardages, 9, 18)}</td>
                                <td className="p-1 text-center font-bold">{calculateTotal(tee.yardages, 0, 18)}</td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>

                <button
                  onClick={saveCourse}
                  className="w-full bg-blue-600 text-white py-4 rounded-xl font-semibold hover:bg-blue-700 text-lg"
                >
                  Save Course
                </button>
              </div>
            </div>
          </div>
        );
      }

      return null;
    }

    ReactDOM.render(<LiveLinks />, document.getElementById('root'));
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>TrackPar - Golf Scorecard</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    /* Prevent zoom on input focus for iOS */
    input {
      font-size: 16px !important;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Lucide icons as inline SVG components
    const Send = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="22" y1="2" x2="11" y2="13"></line>
        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
      </svg>
    );

    const Plus = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    );

    const TrendingUp = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
        <polyline points="17 6 23 6 23 12"></polyline>
      </svg>
    );

    const Calendar = () => (
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
    );

    const MapPin = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
        <circle cx="12" cy="10" r="3"></circle>
      </svg>
    );

    function GolfTracker() {
      const [view, setView] = useState('home');
      const [courses, setCourses] = useState([]);
      const [currentRound, setCurrentRound] = useState(null);
      const [input, setInput] = useState('');
      const [isProcessing, setIsProcessing] = useState(false);
      const [feedback, setFeedback] = useState('');

      const [newCourse, setNewCourse] = useState({
        name: '',
        teeColor: '',
        holes: Array(18).fill(4)
      });

      useEffect(() => {
        loadData();
      }, []);

      const loadData = async () => {
        try {
          const coursesData = await window.storage.get('golf-courses');
          if (coursesData) {
            setCourses(JSON.parse(coursesData.value));
          }
        } catch (error) {
          console.log('No existing courses found');
        }
      };

      const saveCourses = async (updatedCourses) => {
        try {
          await window.storage.set('golf-courses', JSON.stringify(updatedCourses));
        } catch (error) {
          console.error('Failed to save courses:', error);
        }
      };

      const saveRound = async (round) => {
        try {
          const roundKey = `round-${Date.now()}`;
          await window.storage.set(roundKey, JSON.stringify(round));
        } catch (error) {
          console.error('Failed to save round:', error);
        }
      };

      const handleAddCourse = async () => {
        if (!newCourse.name || !newCourse.teeColor) {
          setFeedback('Please enter course name and tee color');
          return;
        }

        const course = {
          id: Date.now(),
          name: newCourse.name,
          teeColor: newCourse.teeColor,
          holes: newCourse.holes
        };

        const updatedCourses = [...courses, course];
        setCourses(updatedCourses);
        await saveCourses(updatedCourses);
        
        setNewCourse({ name: '', teeColor: '', holes: Array(18).fill(4) });
        setFeedback('Course added!');
        setTimeout(() => {
          setFeedback('');
          setView('home');
        }, 1500);
      };

      const startRound = (course) => {
        const round = {
          courseId: course.id,
          courseName: course.name,
          teeColor: course.teeColor,
          date: new Date().toISOString(),
          scores: Array(18).fill(null),
          currentHole: 1,
          coursePars: course.holes
        };
        setCurrentRound(round);
        setView('play-round');
      };

      const processInput = async () => {
        if (!input.trim()) return;
        
        setIsProcessing(true);
        setFeedback('');

        try {
          const inputLower = input.toLowerCase().trim();
          let hole = currentRound.currentHole;
          let score = null;
          let understood = '';

          // Check for hole number in input (e.g., "hole 5", "on 5", "#5", "5th hole")
          const holeMatch = inputLower.match(/(?:hole|on|#)\s*(\d+)|(\d+)(?:th|st|nd|rd)?\s+hole/);
          if (holeMatch) {
            hole = parseInt(holeMatch[1] || holeMatch[2]);
          }

          const par = currentRound.coursePars[hole - 1];

          // Parse score types
          if (/^(\d+)$/.test(inputLower)) {
            // Just a number: "5"
            score = parseInt(inputLower);
            understood = `${score} on hole ${hole}`;
          } else if (inputLower.includes('ace') || inputLower.includes('hole in one')) {
            score = 1;
            understood = `Hole in one on ${hole}! üéâ`;
          } else if (inputLower.includes('eagle')) {
            score = par - 2;
            understood = `Eagle on hole ${hole}! ü¶Ö`;
          } else if (inputLower.includes('birdie')) {
            score = par - 1;
            understood = `Birdie on hole ${hole}! üê¶`;
          } else if (inputLower.includes('par')) {
            score = par;
            understood = `Par on hole ${hole}`;
          } else if (inputLower.includes('bogey') && inputLower.includes('double')) {
            score = par + 2;
            understood = `Double bogey on hole ${hole}`;
          } else if (inputLower.includes('bogey') && inputLower.includes('triple')) {
            score = par + 3;
            understood = `Triple bogey on hole ${hole}`;
          } else if (inputLower.includes('bogey')) {
            score = par + 1;
            understood = `Bogey on hole ${hole}`;
          } else {
            // Try to find any number in the input
            const numMatch = inputLower.match(/(\d+)/);
            if (numMatch) {
              const num = parseInt(numMatch[1]);
              // If it's a reasonable score (2-12), use it
              if (num >= 1 && num <= 12) {
                score = num;
                understood = `${score} on hole ${hole}`;
              }
            }
          }

          if (score === null) {
            setFeedback('Sorry, I didn\'t understand that. Try: "5", "par", "birdie", or "bogey"');
            setIsProcessing(false);
            return;
          }

          // Update the round
          const updatedRound = { ...currentRound };
          updatedRound.scores[hole - 1] = score;
          
          // Move to next hole if scoring current hole
          if (hole === currentRound.currentHole && currentRound.currentHole < 18) {
            updatedRound.currentHole = currentRound.currentHole + 1;
          }
          
          setCurrentRound(updatedRound);
          setFeedback(understood);
          setInput('');

          // Check if round is complete
          if (updatedRound.scores.every(s => s !== null)) {
            await saveRound(updatedRound);
            setTimeout(() => {
              setView('round-summary');
            }, 1500);
          }

        } catch (error) {
          console.error('Error processing input:', error);
          setFeedback('Sorry, something went wrong. Try again!');
        }

        setIsProcessing(false);
      };

      const calculateScore = () => {
        if (!currentRound) return { total: 0, toPar: 0 };
        const total = currentRound.scores.reduce((sum, score) => sum + (score || 0), 0);
        const parTotal = currentRound.coursePars.slice(0, currentRound.currentHole - 1).reduce((sum, par) => sum + par, 0);
        return { total, toPar: total - parTotal };
      };

      if (view === 'home') {
        return (
          <div className="min-h-screen bg-gradient-to-br from-emerald-900 via-green-800 to-teal-900 p-6 font-sans">
            <div className="max-w-2xl mx-auto">
              <div className="text-center mb-12 pt-8">
                <div className="inline-block bg-white/10 backdrop-blur-sm rounded-full px-6 py-2 mb-4">
                  <span className="text-emerald-200 text-sm font-medium tracking-widest uppercase">Golf AI</span>
                </div>
                <h1 className="text-6xl font-bold text-white mb-3" style={{ fontFamily: 'Georgia, serif' }}>
                  TrackPar
                </h1>
                <p className="text-emerald-200 text-lg">Your AI-powered scorecard</p>
              </div>

              <div className="space-y-4 mb-8">
                <button
                  onClick={() => setView('setup-course')}
                  className="w-full bg-white/95 backdrop-blur-sm p-6 rounded-2xl shadow-xl hover:bg-white transition-all transform hover:scale-[1.02] active:scale-[0.98]"
                >
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-4">
                      <div className="bg-emerald-600 p-3 rounded-xl">
                        <Plus />
                      </div>
                      <div className="text-left">
                        <div className="text-xl font-bold text-gray-900">Add Course</div>
                        <div className="text-sm text-gray-600">Set up a new course</div>
                      </div>
                    </div>
                  </div>
                </button>
              </div>

              {courses.length > 0 && (
                <div className="space-y-3">
                  <h2 className="text-white text-lg font-semibold mb-4 flex items-center gap-2">
                    <MapPin />
                    Your Courses
                  </h2>
                  {courses.map((course) => (
                    <button
                      key={course.id}
                      onClick={() => startRound(course)}
                      className="w-full bg-white/90 backdrop-blur-sm p-5 rounded-xl shadow-lg hover:bg-white transition-all transform hover:scale-[1.01] active:scale-[0.99] text-left"
                    >
                      <div className="flex items-center justify-between">
                        <div>
                          <div className="text-lg font-bold text-gray-900">{course.name}</div>
                          <div className="text-sm text-gray-600">
                            {course.teeColor} Tees ¬∑ Par {course.holes.reduce((a, b) => a + b, 0)}
                          </div>
                        </div>
                        <div className="bg-emerald-600 p-2 rounded-lg">
                          <TrendingUp />
                        </div>
                      </div>
                    </button>
                  ))}
                </div>
              )}

              {courses.length === 0 && (
                <div className="bg-white/80 backdrop-blur-sm p-8 rounded-2xl text-center">
                  <Calendar />
                  <p className="text-gray-700 mb-2 font-semibold">No courses yet</p>
                  <p className="text-gray-600 text-sm">Add your first course to start tracking rounds</p>
                </div>
              )}
            </div>
          </div>
        );
      }

      if (view === 'setup-course') {
        return (
          <div className="min-h-screen bg-gradient-to-br from-emerald-900 via-green-800 to-teal-900 p-6">
            <div className="max-w-2xl mx-auto">
              <button
                onClick={() => setView('home')}
                className="text-white mb-6 hover:text-emerald-200 transition-colors"
              >
                ‚Üê Back
              </button>

              <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-8">
                <h2 className="text-3xl font-bold text-gray-900 mb-6" style={{ fontFamily: 'Georgia, serif' }}>
                  Add Course
                </h2>

                <div className="space-y-6">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Course Name</label>
                    <input
                      type="text"
                      value={newCourse.name}
                      onChange={(e) => setNewCourse({ ...newCourse, name: e.target.value })}
                      placeholder="Pebble Beach Golf Links"
                      className="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-emerald-500 focus:outline-none transition-colors"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Tee Color</label>
                    <input
                      type="text"
                      value={newCourse.teeColor}
                      onChange={(e) => setNewCourse({ ...newCourse, teeColor: e.target.value })}
                      placeholder="Blue, White, Gold..."
                      className="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-emerald-500 focus:outline-none transition-colors"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-3">Par for Each Hole</label>
                    <div className="grid grid-cols-6 gap-2">
                      {newCourse.holes.map((par, idx) => (
                        <div key={idx}>
                          <label className="block text-xs text-gray-500 mb-1 text-center">#{idx + 1}</label>
                          <input
                            type="number"
                            value={par}
                            onChange={(e) => {
                              const updated = [...newCourse.holes];
                              updated[idx] = parseInt(e.target.value) || 3;
                              setNewCourse({ ...newCourse, holes: updated });
                            }}
                            min="3"
                            max="5"
                            className="w-full px-2 py-2 text-center rounded-lg border-2 border-gray-200 focus:border-emerald-500 focus:outline-none"
                          />
                        </div>
                      ))}
                    </div>
                  </div>

                  {feedback && (
                    <div className="bg-emerald-50 border-2 border-emerald-200 text-emerald-800 px-4 py-3 rounded-xl">
                      {feedback}
                    </div>
                  )}

                  <button
                    onClick={handleAddCourse}
                    className="w-full bg-emerald-600 text-white py-4 rounded-xl font-semibold text-lg hover:bg-emerald-700 transition-colors shadow-lg"
                  >
                    Save Course
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      }

      if (view === 'play-round') {
        const { total, toPar } = calculateScore();

        return (
          <div className="min-h-screen bg-gradient-to-br from-emerald-900 via-green-800 to-teal-900 p-6">
            <div className="max-w-2xl mx-auto">
              <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6 mb-6">
                <div className="flex justify-between items-start mb-4">
                  <div>
                    <h2 className="text-2xl font-bold text-gray-900">{currentRound.courseName}</h2>
                    <p className="text-gray-600">{currentRound.teeColor} Tees</p>
                  </div>
                  <button
                    onClick={() => {
                      if (confirm('End this round?')) {
                        setView('home');
                        setCurrentRound(null);
                      }
                    }}
                    className="text-red-600 hover:text-red-700 text-sm font-semibold"
                  >
                    End Round
                  </button>
                </div>

                <div className="grid grid-cols-3 gap-4 mt-6">
                  <div className="text-center">
                    <div className="text-3xl font-bold text-gray-900">{total}</div>
                    <div className="text-sm text-gray-600">Total</div>
                  </div>
                  <div className="text-center">
                    <div className={`text-3xl font-bold ${toPar > 0 ? 'text-red-600' : toPar < 0 ? 'text-emerald-600' : 'text-gray-900'}`}>
                      {toPar > 0 ? '+' : ''}{toPar}
                    </div>
                    <div className="text-sm text-gray-600">To Par</div>
                  </div>
                  <div className="text-center">
                    <div className="text-3xl font-bold text-gray-900">{currentRound.currentHole}</div>
                    <div className="text-sm text-gray-600">Current Hole</div>
                  </div>
                </div>
              </div>

              <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6 mb-6">
                <label className="block text-sm font-semibold text-gray-700 mb-3">
                  Enter Score (Hole {currentRound.currentHole})
                </label>
                <div className="flex gap-3">
                  <input
                    type="text"
                    value={input}
                    onChange={(e) => setInput(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && processInput()}
                    placeholder='Try: "5" or "par" or "birdie on 3"'
                    className="flex-1 px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-emerald-500 focus:outline-none"
                    disabled={isProcessing}
                  />
                  <button
                    onClick={processInput}
                    disabled={isProcessing}
                    className="bg-emerald-600 text-white px-6 py-3 rounded-xl hover:bg-emerald-700 transition-colors disabled:bg-gray-400 shadow-lg"
                  >
                    <Send />
                  </button>
                </div>
                {feedback && (
                  <div className="mt-3 bg-emerald-50 border-2 border-emerald-200 text-emerald-800 px-4 py-2 rounded-xl text-sm">
                    {feedback}
                  </div>
                )}
              </div>

              <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6">
                <h3 className="text-lg font-bold text-gray-900 mb-4">Scorecard</h3>
                <div className="grid grid-cols-9 gap-2">
                  {currentRound.scores.slice(0, 9).map((score, idx) => (
                    <div key={idx} className="text-center">
                      <div className="text-xs text-gray-500 mb-1">#{idx + 1}</div>
                      <div className="bg-gray-100 rounded-lg py-2 font-bold text-sm">
                        {score || '-'}
                      </div>
                      <div className="text-xs text-gray-400 mt-1">Par {currentRound.coursePars[idx]}</div>
                    </div>
                  ))}
                </div>
                <div className="grid grid-cols-9 gap-2 mt-4">
                  {currentRound.scores.slice(9, 18).map((score, idx) => (
                    <div key={idx + 9} className="text-center">
                      <div className="text-xs text-gray-500 mb-1">#{idx + 10}</div>
                      <div className="bg-gray-100 rounded-lg py-2 font-bold text-sm">
                        {score || '-'}
                      </div>
                      <div className="text-xs text-gray-400 mt-1">Par {currentRound.coursePars[idx + 9]}</div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
        );
      }

      if (view === 'round-summary') {
        const { total, toPar } = calculateScore();
        
        return (
          <div className="min-h-screen bg-gradient-to-br from-emerald-900 via-green-800 to-teal-900 p-6">
            <div className="max-w-2xl mx-auto pt-12">
              <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-8 text-center">
                <div className="text-6xl mb-4">üèåÔ∏è</div>
                <h2 className="text-4xl font-bold text-gray-900 mb-2" style={{ fontFamily: 'Georgia, serif' }}>
                  Round Complete!
                </h2>
                <p className="text-gray-600 mb-8">{currentRound.courseName}</p>
                
                <div className="grid grid-cols-2 gap-6 mb-8">
                  <div className="bg-emerald-50 rounded-xl p-6">
                    <div className="text-4xl font-bold text-emerald-600">{total}</div>
                    <div className="text-sm text-gray-600 mt-1">Total Score</div>
                  </div>
                  <div className="bg-emerald-50 rounded-xl p-6">
                    <div className={`text-4xl font-bold ${toPar > 0 ? 'text-red-600' : toPar < 0 ? 'text-emerald-600' : 'text-gray-900'}`}>
                      {toPar > 0 ? '+' : ''}{toPar}
                    </div>
                    <div className="text-sm text-gray-600 mt-1">To Par</div>
                  </div>
                </div>

                <button
                  onClick={() => {
                    setView('home');
                    setCurrentRound(null);
                  }}
                  className="w-full bg-emerald-600 text-white py-4 rounded-xl font-semibold text-lg hover:bg-emerald-700 transition-colors shadow-lg"
                >
                  Back to Home
                </button>
              </div>
            </div>
          </div>
        );
      }

      return null;
    }

    ReactDOM.render(<GolfTracker />, document.getElementById('root'));
  </script>
</body>
</html>

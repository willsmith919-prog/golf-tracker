<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>LiveLinks - Real-time Golf Scoring</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  
  <style>
    body { margin: 0; padding: 0; overflow-x: hidden; }
    input, textarea { font-size: 16px !important; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyB8u4N8yPT9VJejYCgfT_v_FSGohCghr1M",
      authDomain: "livelinks-cf018.firebaseapp.com",
      databaseURL: "https://livelinks-cf018-default-rtdb.firebaseio.com",
      projectId: "livelinks-cf018",
      storageBucket: "livelinks-cf018.firebasestorage.app",
      messagingSenderId: "658641708649",
      appId: "1:658641708649:web:620bd1327d75c3678424f8"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const database = firebase.database();

    // Generate or retrieve device ID
    const getDeviceId = () => {
      let deviceId = localStorage.getItem('deviceId');
      if (!deviceId) {
        deviceId = 'device-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('deviceId', deviceId);
      }
      return deviceId;
    };

    // Generate short event code
    const generateEventCode = async (courseId) => {
      const coursePrefix = courseId.split('-')[0].toUpperCase().substring(0, 4);
      const randomPart = Math.random().toString(36).substring(2, 6).toUpperCase();
      const code = `${coursePrefix}-${randomPart}`;
      
      // Check if code exists
      const snapshot = await database.ref('eventCodes').child(code).once('value');
      if (snapshot.exists()) {
        // Collision - regenerate
        return generateEventCode(courseId);
      }
      
      return code;
    };

    // Icons
    const Plus = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>);
    const Users = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>);
    const Calendar = () => (<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>);
    const Trash = () => (<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>);
    const Trophy = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg>);
    const Link = () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>);
    const BarChart = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>);
    const ClipboardList = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>);
    const Copy = () => (<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>);
    const ChevronDown = () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="6 9 12 15 18 9"></polyline></svg>);
    const ChevronUp = () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="18 15 12 9 6 15"></polyline></svg>);
    const RotateCcw = () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>);

    function LiveLinks() {
      const [view, setView] = useState('home');
      const [courses, setCourses] = useState([]);
      const [newEvent, setNewEvent] = useState({
        name: '',
        courseId: '',
        date: new Date().toISOString().split('T')[0],
        teams: []
      });
      const [newTeam, setNewTeam] = useState({ name: '', player1: '', player2: '' });
      const [joinCode, setJoinCode] = useState('');
      const [currentEvent, setCurrentEvent] = useState(null);
      const [selectedTeam, setSelectedTeam] = useState(null);
      const [feedback, setFeedback] = useState('');
      const [scoreConfirmation, setScoreConfirmation] = useState(null);
      const [expandedTeams, setExpandedTeams] = useState([]);
      const [editingHole, setEditingHole] = useState(null);
      const eventListenerRef = useRef(null);
      const undoTimerRef = useRef(null);
      const deviceId = getDeviceId();

      useEffect(() => { loadCourses(); }, []);

      useEffect(() => {
        return () => {
          if (eventListenerRef.current) {
            eventListenerRef.current.off();
          }
          if (undoTimerRef.current) {
            clearTimeout(undoTimerRef.current);
          }
        };
      }, []);

      const loadCourses = () => {
        try {
          const coursesData = localStorage.getItem('golf-courses');
          if (coursesData) {
            setCourses(JSON.parse(coursesData));
          } else {
            const defaultCourses = [
              { id: 'davis-park', name: "Davis Park", teeColor: "White", holes: [4,3,5,4,4,4,3,5,4,5,3,4,5,3,4,3,4,4] },
              { id: 'valley-view', name: "Valley View", teeColor: "White", holes: [4,5,4,3,4,4,3,4,5,4,5,3,4,4,4,3,5,4] },
              { id: 'wolf-creek', name: "Wolf Creek Golf Club", teeColor: "Masters", holes: [5,4,3,4,5,4,4,3,4,4,3,5,4,4,3,4,5,4] },
              { id: 'sand-hollow', name: "Sand Hollow Golf Course", teeColor: "Signature", holes: [4,5,3,4,4,4,5,3,4,5,3,4,4,4,3,4,5,4] }
            ];
            setCourses(defaultCourses);
            localStorage.setItem('golf-courses', JSON.stringify(defaultCourses));
          }
        } catch (error) {
          console.error('Error loading courses:', error);
        }
      };

      const addTeam = () => {
        if (!newTeam.name || !newTeam.player1 || !newTeam.player2) {
          setFeedback('Please fill in all team fields');
          setTimeout(() => setFeedback(''), 2000);
          return;
        }
        setNewEvent({
          ...newEvent,
          teams: [...newEvent.teams, { ...newTeam, id: Date.now() }]
        });
        setNewTeam({ name: '', player1: '', player2: '' });
      };

      const removeTeam = (teamId) => {
        setNewEvent({
          ...newEvent,
          teams: newEvent.teams.filter(t => t.id !== teamId)
        });
      };

      const createEvent = async () => {
        if (!newEvent.name || !newEvent.courseId || newEvent.teams.length < 2) {
          setFeedback('Please add event name, course, and at least 2 teams');
          setTimeout(() => setFeedback(''), 3000);
          return;
        }

        try {
          const course = courses.find(c => c.id === newEvent.courseId);
          const eventId = 'event-' + Date.now();
          const eventCode = await generateEventCode(course.id);
          
          const eventData = {
            meta: {
              name: newEvent.name,
              courseId: course.id,
              courseName: course.name,
              coursePars: course.holes,
              format: "2-man-scramble",
              date: newEvent.date,
              createdBy: deviceId,
              status: "active",
              createdAt: Date.now(),
              eventCode: eventCode
            },
            teams: {}
          };

          newEvent.teams.forEach((team, index) => {
            eventData.teams[`team${index + 1}`] = {
              name: team.name,
              players: [team.player1, team.player2],
              scores: Array(18).fill(null),
              currentHole: 1
            };
          });

          // Write to Firebase
          await database.ref(`events/${eventId}`).set(eventData);
          
          // Store code mapping
          await database.ref(`eventCodes/${eventCode}`).set(eventId);
          
          setFeedback(`Event created! Code: ${eventCode}`);
          
          setTimeout(() => {
            setCurrentEvent({ id: eventId, ...eventData });
            setView('event-lobby');
          }, 2000);

        } catch (error) {
          console.error('Error creating event:', error);
          setFeedback('Error creating event. Please try again.');
          setTimeout(() => setFeedback(''), 3000);
        }
      };

      const joinEvent = async () => {
        if (!joinCode.trim()) {
          setFeedback('Please enter an event code');
          setTimeout(() => setFeedback(''), 2000);
          return;
        }

        try {
          // Check if it's a short code
          let eventId = joinCode.trim();
          
          if (!eventId.startsWith('event-')) {
            // It's a short code - look up the real ID
            const codeSnapshot = await database.ref(`eventCodes/${eventId}`).once('value');
            const realId = codeSnapshot.val();
            
            if (!realId) {
              setFeedback('Event not found. Check your code.');
              setTimeout(() => setFeedback(''), 3000);
              return;
            }
            
            eventId = realId;
          }
          
          const snapshot = await database.ref(`events/${eventId}`).once('value');
          const eventData = snapshot.val();
          
          if (!eventData) {
            setFeedback('Event not found. Check your code.');
            setTimeout(() => setFeedback(''), 3000);
            return;
          }

          setCurrentEvent({ id: eventId, ...eventData });
          setView('event-lobby');
          setJoinCode('');
        } catch (error) {
          console.error('Error joining event:', error);
          setFeedback('Error joining event. Please try again.');
          setTimeout(() => setFeedback(''), 3000);
        }
      };

      const startRealtimeSync = (eventId) => {
        if (eventListenerRef.current) {
          eventListenerRef.current.off();
        }

        const eventRef = database.ref(`events/${eventId}`);
        eventListenerRef.current = eventRef;

        return new Promise((resolve) => {
          eventRef.once('value', (snapshot) => {
            const eventData = snapshot.val();
            if (eventData) {
              setCurrentEvent({ id: eventId, ...eventData });
              resolve(eventData);
            }
          });

          // Then set up continuous listening
          eventRef.on('value', (snapshot) => {
            const eventData = snapshot.val();
            if (eventData) {
              setCurrentEvent({ id: eventId, ...eventData });
            }
          });
        });
      };

      const selectTeam = async (teamId) => {
        setSelectedTeam(teamId);
        // Wait for initial data load before switching to scoring view
        await startRealtimeSync(currentEvent.id);
        setView('scoring');
      };

      const submitScore = async (score, holeOverride = null) => {
        try {
          // Safety checks
          if (!currentEvent || !currentEvent.teams || !selectedTeam) {
            console.error('Missing event or team data');
            return;
          }

          const team = currentEvent.teams[selectedTeam];
          if (!team || !team.scores) {
            console.error('Team or scores array not found');
            return;
          }

          const holeNum = holeOverride !== null ? holeOverride : team.currentHole;
          const holeIndex = holeNum - 1;
          
          // Store previous values for undo
          const previousScore = team.scores[holeIndex];
          const previousHole = team.currentHole;
          
          // Update score
          await database.ref(`events/${currentEvent.id}/teams/${selectedTeam}/scores/${holeIndex}`).set(score);
          
          // Update current hole if not on 18 and not editing
          if (holeOverride === null && team.currentHole < 18) {
            await database.ref(`events/${currentEvent.id}/teams/${selectedTeam}/currentHole`).set(team.currentHole + 1);
          }

          // Show confirmation with undo option
          setScoreConfirmation({
            message: `${score} recorded on hole ${holeNum}`,
            undoData: { holeIndex, previousScore, previousHole, score }
          });

          // Auto-hide after 5 seconds
          if (undoTimerRef.current) clearTimeout(undoTimerRef.current);
          undoTimerRef.current = setTimeout(() => {
            setScoreConfirmation(null);
          }, 5000);

        } catch (error) {
          console.error('Error submitting score:', error);
          setScoreConfirmation({ message: 'Error submitting score', undoData: null });
          setTimeout(() => setScoreConfirmation(null), 2000);
        }
      };

      const undoScore = async () => {
        if (!scoreConfirmation?.undoData) return;
        
        const { holeIndex, previousScore, previousHole } = scoreConfirmation.undoData;
        
        try {
          // Revert score
          await database.ref(`events/${currentEvent.id}/teams/${selectedTeam}/scores/${holeIndex}`).set(previousScore);
          
          // Revert current hole
          await database.ref(`events/${currentEvent.id}/teams/${selectedTeam}/currentHole`).set(previousHole);
          
          setScoreConfirmation({ message: 'Score removed', undoData: null });
          setTimeout(() => setScoreConfirmation(null), 2000);
          
        } catch (error) {
          console.error('Error undoing score:', error);
        }
      };

      const copyEventCode = () => {
        const code = currentEvent.meta.eventCode;
        navigator.clipboard.writeText(code).then(() => {
          setFeedback('Code copied!');
          setTimeout(() => setFeedback(''), 2000);
        });
      };

      const toggleTeamExpansion = (teamId) => {
        if (expandedTeams.includes(teamId)) {
          setExpandedTeams(expandedTeams.filter(id => id !== teamId));
        } else {
          setExpandedTeams([...expandedTeams, teamId]);
        }
      };

      const calculateTeamStats = (team) => {
        const scores = team.scores || [];
        const validScores = scores.filter(s => s !== null);
        const total = validScores.reduce((sum, s) => sum + s, 0);
        const holesCompleted = validScores.length;
        
        const pars = currentEvent?.meta?.coursePars || [];
        let parTotal = 0;
        for (let i = 0; i < scores.length; i++) {
          if (scores[i] !== null && pars[i]) {
            parTotal += pars[i];
          }
        }
        
        const toPar = total - parTotal;
        return { total, holesCompleted, toPar };
      };

      // HOME VIEW
      if (view === 'home') {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900 p-6 font-sans">
            <div className="max-w-2xl mx-auto">
              <div className="text-center mb-12 pt-8">
                <div className="inline-block bg-white/10 backdrop-blur-sm rounded-full px-6 py-2 mb-4">
                  <span className="text-blue-200 text-sm font-medium tracking-widest uppercase">Golf Events</span>
                </div>
                <h1 className="text-6xl font-bold text-white mb-3" style={{ fontFamily: 'Georgia, serif' }}>LiveLinks</h1>
                <p className="text-blue-200 text-lg">Real-time golf scoring</p>
              </div>

              <div className="space-y-4">
                <button onClick={() => setView('create-event')} className="w-full bg-white/95 backdrop-blur-sm p-6 rounded-2xl shadow-xl hover:bg-white transition-all">
                  <div className="flex items-center gap-4">
                    <div className="bg-blue-600 p-3 rounded-xl"><Trophy /></div>
                    <div className="text-left">
                      <div className="text-xl font-bold text-gray-900">Create Event</div>
                      <div className="text-sm text-gray-600">Host a new golf event</div>
                    </div>
                  </div>
                </button>

                <div className="bg-white/95 backdrop-blur-sm p-6 rounded-2xl shadow-xl">
                  <div className="flex items-center gap-4 mb-4">
                    <div className="bg-indigo-600 p-3 rounded-xl"><Link /></div>
                    <div className="text-left">
                      <div className="text-xl font-bold text-gray-900">Join Event</div>
                      <div className="text-sm text-gray-600">Enter event code</div>
                    </div>
                  </div>
                  <div className="flex gap-3">
                    <input
                      type="text"
                      value={joinCode}
                      onChange={(e) => setJoinCode(e.target.value.toUpperCase())}
                      onKeyPress={(e) => e.key === 'Enter' && joinEvent()}
                      placeholder="WOLF-A3X9"
                      className="flex-1 px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-indigo-500 focus:outline-none uppercase"
                    />
                    <button
                      onClick={joinEvent}
                      className="bg-indigo-600 text-white px-6 py-3 rounded-xl hover:bg-indigo-700 font-semibold"
                    >
                      Join
                    </button>
                  </div>
                  {feedback && <div className="mt-3 text-sm text-indigo-600">{feedback}</div>}
                </div>
              </div>
            </div>
          </div>
        );
      }

      // CREATE EVENT VIEW
      if (view === 'create-event') {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900 p-6">
            <div className="max-w-2xl mx-auto">
              <button onClick={() => setView('home')} className="text-white mb-6 hover:text-blue-200">← Back</button>
              <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-8">
                <h2 className="text-3xl font-bold text-gray-900 mb-6" style={{ fontFamily: 'Georgia, serif' }}>Create Event</h2>
                
                <div className="space-y-6">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Event Name</label>
                    <input
                      type="text"
                      value={newEvent.name}
                      onChange={(e) => setNewEvent({ ...newEvent, name: e.target.value })}
                      placeholder="March Scramble"
                      className="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Course</label>
                    <select
                      value={newEvent.courseId}
                      onChange={(e) => setNewEvent({ ...newEvent, courseId: e.target.value })}
                      className="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none"
                    >
                      <option value="">Select a course</option>
                      {courses.map(course => (
                        <option key={course.id} value={course.id}>
                          {course.name} - {course.teeColor} Tees
                        </option>
                      ))}
                    </select>
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Date</label>
                    <input
                      type="date"
                      value={newEvent.date}
                      onChange={(e) => setNewEvent({ ...newEvent, date: e.target.value })}
                      className="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-3">Teams ({newEvent.teams.length})</label>
                    
                    {newEvent.teams.length > 0 && (
                      <div className="space-y-2 mb-4">
                        {newEvent.teams.map(team => (
                          <div key={team.id} className="bg-gray-50 p-4 rounded-xl flex items-center justify-between">
                            <div>
                              <div className="font-semibold text-gray-900">{team.name}</div>
                              <div className="text-sm text-gray-600">{team.player1} & {team.player2}</div>
                            </div>
                            <button onClick={() => removeTeam(team.id)} className="text-red-600 hover:text-red-700 p-2">
                              <Trash />
                            </button>
                          </div>
                        ))}
                      </div>
                    )}

                    {newEvent.teams.length < 6 && (
                      <div className="bg-blue-50 p-4 rounded-xl space-y-3">
                        <input
                          type="text"
                          value={newTeam.name}
                          onChange={(e) => setNewTeam({ ...newTeam, name: e.target.value })}
                          placeholder="Team name"
                          className="w-full px-4 py-2 rounded-lg border-2 border-blue-200 focus:border-blue-500 focus:outline-none"
                        />
                        <div className="grid grid-cols-2 gap-3">
                          <input
                            type="text"
                            value={newTeam.player1}
                            onChange={(e) => setNewTeam({ ...newTeam, player1: e.target.value })}
                            placeholder="Player 1"
                            className="px-4 py-2 rounded-lg border-2 border-blue-200 focus:border-blue-500 focus:outline-none"
                          />
                          <input
                            type="text"
                            value={newTeam.player2}
                            onChange={(e) => setNewTeam({ ...newTeam, player2: e.target.value })}
                            placeholder="Player 2"
                            className="px-4 py-2 rounded-lg border-2 border-blue-200 focus:border-blue-500 focus:outline-none"
                          />
                        </div>
                        <button
                          onClick={addTeam}
                          className="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 font-semibold"
                        >
                          Add Team
                        </button>
                      </div>
                    )}
                  </div>

                  {feedback && (
                    <div className="bg-blue-50 border-2 border-blue-200 text-blue-800 px-4 py-3 rounded-xl text-sm">
                      {feedback}
                    </div>
                  )}

                  <button
                    onClick={createEvent}
                    className="w-full bg-blue-600 text-white py-4 rounded-xl font-semibold text-lg hover:bg-blue-700 shadow-lg"
                  >
                    Create Event
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // EVENT LOBBY VIEW
      if (view === 'event-lobby' && currentEvent) {
        const teams = Object.entries(currentEvent.teams || {});
        
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900 p-6">
            <div className="max-w-2xl mx-auto">
              <button onClick={() => { setView('home'); setCurrentEvent(null); }} className="text-white mb-6 hover:text-blue-200">← Leave Event</button>
              
              <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-8">
                <div className="text-center mb-8">
                  <h2 className="text-3xl font-bold text-gray-900 mb-2">{currentEvent.meta.name}</h2>
                  <p className="text-gray-600 mb-4">{currentEvent.meta.courseName} - {currentEvent.meta.date}</p>
                  <div className="inline-block bg-blue-50 px-4 py-2 rounded-lg">
                    <div className="text-xs text-gray-600 mb-1">Event Code</div>
                    <div className="font-mono font-bold text-blue-600 text-xl">{currentEvent.meta.eventCode}</div>
                  </div>
                </div>

                <div className="mb-6">
                  <h3 className="text-lg font-semibold text-gray-900 mb-3">Teams</h3>
                  <div className="space-y-3">
                    {teams.map(([teamId, team]) => (
                      <div key={teamId} className="bg-gray-50 p-4 rounded-xl">
                        <div className="font-semibold text-gray-900 mb-1">{team.name}</div>
                        <div className="text-sm text-gray-600">{team.players.join(' & ')}</div>
                      </div>
                    ))}
                  </div>
                </div>

                <button
                  onClick={() => setView('team-selection')}
                  className="w-full bg-blue-600 text-white py-4 rounded-xl font-semibold text-lg hover:bg-blue-700 shadow-lg"
                >
                  Select Team & Start Scoring
                </button>
              </div>
            </div>
          </div>
        );
      }

      // TEAM SELECTION VIEW
      if (view === 'team-selection' && currentEvent) {
        const teams = Object.entries(currentEvent.teams || {});
        
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900 p-6">
            <div className="max-w-2xl mx-auto">
              <button onClick={() => setView('event-lobby')} className="text-white mb-6 hover:text-blue-200">← Back</button>
              
              <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-8">
                <h2 className="text-3xl font-bold text-gray-900 mb-2" style={{ fontFamily: 'Georgia, serif' }}>Select Your Team</h2>
                <p className="text-gray-600 mb-8">Choose which team you're scoring for</p>
                
                <div className="space-y-3">
                  {teams.map(([teamId, team]) => (
                    <button
                      key={teamId}
                      onClick={() => selectTeam(teamId)}
                      className="w-full bg-gray-50 hover:bg-blue-50 p-6 rounded-xl transition-all text-left border-2 border-transparent hover:border-blue-500"
                    >
                      <div className="font-bold text-xl text-gray-900 mb-2">{team.name}</div>
                      <div className="text-gray-600">{team.players.join(' & ')}</div>
                    </button>
                  ))}
                </div>
              </div>
            </div>
          </div>
        );
      }

      // SCORING VIEW
      if (view === 'scoring' && currentEvent && selectedTeam) {
        // Safety check - make sure team exists
        if (!currentEvent.teams || !currentEvent.teams[selectedTeam]) {
          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900 p-6 flex items-center justify-center">
              <div className="bg-white/95 p-8 rounded-2xl text-center">
                <p className="text-gray-900 mb-4">Loading team data...</p>
                <button onClick={() => setView('team-selection')} className="text-blue-600">Go Back</button>
              </div>
            </div>
          );
        }

        const team = currentEvent.teams[selectedTeam];
        const currentHoleNum = team.currentHole;
        const coursePars = currentEvent?.meta?.coursePars || [];
        const currentPar = coursePars[currentHoleNum - 1] || 4;
        const stats = calculateTeamStats(team);
        
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900 p-6 flex flex-col">
            {/* Header */}
            <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6 mb-6">
              <div className="text-center mb-4">
                <h2 className="text-2xl font-bold text-gray-900">{currentEvent.meta.name}</h2>
                <div className="text-lg text-gray-600">{team.name}</div>
              </div>
              
              <div className="grid grid-cols-3 gap-4 text-center">
                <div>
                  <div className="text-sm text-gray-600">Hole</div>
                  <div className="text-3xl font-bold text-blue-600">{currentHoleNum}</div>
                </div>
                <div>
                  <div className="text-sm text-gray-600">Par</div>
                  <div className="text-3xl font-bold text-gray-900">{currentPar}</div>
                </div>
                <div>
                  <div className="text-sm text-gray-600">Score</div>
                  <div className={`text-3xl font-bold ${stats.toPar > 0 ? 'text-red-600' : stats.toPar < 0 ? 'text-green-600' : 'text-gray-900'}`}>
                    {stats.toPar > 0 ? '+' : ''}{stats.toPar}
                  </div>
                </div>
              </div>
            </div>

            {/* Score Buttons */}
            <div className="flex-1 bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6">
              <h3 className="text-xl font-semibold text-gray-900 mb-4 text-center">Enter Score</h3>
              
              <div className="grid grid-cols-5 gap-3 mb-6">
                {[1,2,3,4,5,6,7,8,9,10].map(score => (
                  <button
                    key={score}
                    onClick={() => submitScore(score === 10 ? 10 : score)}
                    className={`py-6 rounded-xl font-bold text-2xl transition-all ${
                      score === currentPar
                        ? 'bg-blue-600 text-white hover:bg-blue-700'
                        : score < currentPar
                        ? 'bg-green-100 text-green-700 hover:bg-green-200'
                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                    }`}
                  >
                    {score === 10 ? '10+' : score}
                  </button>
                ))}
              </div>

              {scoreConfirmation && (
                <div className="bg-green-50 border-2 border-green-200 p-4 rounded-xl mb-4">
                  <div className="text-green-800 text-center mb-3">{scoreConfirmation.message}</div>
                  {scoreConfirmation.undoData && (
                    <button
                      onClick={undoScore}
                      className="w-full bg-orange-500 text-white py-2 rounded-lg hover:bg-orange-600 font-semibold flex items-center justify-center gap-2"
                    >
                      <RotateCcw />
                      Undo
                    </button>
                  )}
                </div>
              )}

              <div className="grid grid-cols-2 gap-3">
                <button
                  onClick={() => setView('scorecard')}
                  className="bg-gray-600 text-white py-4 rounded-xl font-semibold hover:bg-gray-700 flex items-center justify-center gap-2"
                >
                  <ClipboardList />
                  Scorecard
                </button>
                <button
                  onClick={() => setView('leaderboard')}
                  className="bg-indigo-600 text-white py-4 rounded-xl font-semibold hover:bg-indigo-700 flex items-center justify-center gap-2"
                >
                  <BarChart />
                  Leaderboard
                </button>
              </div>
            </div>
          </div>
        );
      }

      // SCORECARD VIEW
      if (view === 'scorecard' && currentEvent && selectedTeam) {
        const team = currentEvent.teams[selectedTeam];
        const pars = currentEvent?.meta?.coursePars || Array(18).fill(4);
        
        const front9Total = team.scores.slice(0, 9).reduce((sum, s) => sum + (s || 0), 0);
        const back9Total = team.scores.slice(9, 18).reduce((sum, s) => sum + (s || 0), 0);
        const front9Par = pars.slice(0, 9).reduce((sum, p) => sum + p, 0);
        const back9Par = pars.slice(9, 18).reduce((sum, p) => sum + p, 0);
        
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900 p-6">
            <div className="max-w-2xl mx-auto">
              <button onClick={() => setView('scoring')} className="text-white mb-6 hover:text-blue-200">← Back to Scoring</button>
              
              <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-8">
                <h2 className="text-2xl font-bold text-gray-900 mb-2 text-center">{team.name}</h2>
                <p className="text-gray-600 mb-6 text-center">Scorecard</p>
                
                {/* Front 9 */}
                <div className="mb-6">
                  <h3 className="text-sm font-semibold text-gray-700 mb-3">Front 9</h3>
                  <div className="grid grid-cols-9 gap-1 mb-2">
                    {pars.slice(0, 9).map((par, idx) => (
                      <button
                        key={idx}
                        onClick={() => setEditingHole(idx + 1)}
                        className="bg-gray-50 hover:bg-blue-50 p-2 rounded text-center cursor-pointer"
                      >
                        <div className="text-xs text-gray-500">#{idx + 1}</div>
                        <div className="text-xs text-gray-400">Par {par}</div>
                        <div className={`font-bold ${
                          team.scores[idx] === null ? 'text-gray-300' :
                          team.scores[idx] < par ? 'text-green-600' :
                          team.scores[idx] > par ? 'text-red-600' :
                          'text-gray-900'
                        }`}>
                          {team.scores[idx] || '-'}
                        </div>
                      </button>
                    ))}
                  </div>
                  <div className="text-right text-sm font-semibold">
                    Total: {front9Total} ({front9Total - front9Par > 0 ? '+' : ''}{front9Total - front9Par})
                  </div>
                </div>

                {/* Back 9 */}
                <div className="mb-6">
                  <h3 className="text-sm font-semibold text-gray-700 mb-3">Back 9</h3>
                  <div className="grid grid-cols-9 gap-1 mb-2">
                    {pars.slice(9, 18).map((par, idx) => {
                      const holeNum = idx + 10;
                      const holeIdx = idx + 9;
                      return (
                        <button
                          key={holeIdx}
                          onClick={() => setEditingHole(holeNum)}
                          className="bg-gray-50 hover:bg-blue-50 p-2 rounded text-center cursor-pointer"
                        >
                          <div className="text-xs text-gray-500">#{holeNum}</div>
                          <div className="text-xs text-gray-400">Par {par}</div>
                          <div className={`font-bold ${
                            team.scores[holeIdx] === null ? 'text-gray-300' :
                            team.scores[holeIdx] < par ? 'text-green-600' :
                            team.scores[holeIdx] > par ? 'text-red-600' :
                            'text-gray-900'
                          }`}>
                            {team.scores[holeIdx] || '-'}
                          </div>
                        </button>
                      );
                    })}
                  </div>
                  <div className="text-right text-sm font-semibold">
                    Total: {back9Total} ({back9Total - back9Par > 0 ? '+' : ''}{back9Total - back9Par})
                  </div>
                </div>

                {/* Total */}
                <div className="bg-blue-50 p-4 rounded-xl">
                  <div className="flex justify-between items-center">
                    <span className="font-semibold text-gray-900">Total Score</span>
                    <span className="text-2xl font-bold text-blue-600">
                      {front9Total + back9Total} ({(front9Total + back9Total) - (front9Par + back9Par) > 0 ? '+' : ''}{(front9Total + back9Total) - (front9Par + back9Par)})
                    </span>
                  </div>
                </div>
              </div>
            </div>

            {/* Edit Score Modal */}
            {editingHole && (
              <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
                  <h3 className="text-xl font-bold text-gray-900 mb-2">Edit Hole {editingHole}</h3>
                  <p className="text-gray-600 mb-4">
                    Par {pars[editingHole - 1]} - Current: {team.scores[editingHole - 1] || 'Not recorded'}
                  </p>
                  
                  <div className="grid grid-cols-5 gap-2 mb-4">
                    {[1,2,3,4,5,6,7,8,9,10].map(score => (
                      <button
                        key={score}
                        onClick={() => {
                          submitScore(score === 10 ? 10 : score, editingHole);
                          setEditingHole(null);
                        }}
                        className="py-4 rounded-lg font-bold text-lg bg-gray-100 hover:bg-blue-100 text-gray-900"
                      >
                        {score === 10 ? '10+' : score}
                      </button>
                    ))}
                  </div>
                  
                  <button
                    onClick={() => setEditingHole(null)}
                    className="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-300"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            )}
          </div>
        );
      }

      // LEADERBOARD VIEW
      if (view === 'leaderboard' && currentEvent) {
        const teams = Object.entries(currentEvent.teams || {}).map(([teamId, team]) => ({
          teamId,
          ...team,
          stats: calculateTeamStats(team)
        }));

        teams.sort((a, b) => a.stats.total - b.stats.total);
        
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900 p-6">
            <div className="max-w-2xl mx-auto">
              <button onClick={() => setView('scoring')} className="text-white mb-6 hover:text-blue-200">← Back to Scoring</button>
              
              <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-8">
                <div className="text-center mb-8">
                  <div className="inline-block bg-blue-600 p-3 rounded-xl mb-4">
                    <Trophy />
                  </div>
                  <h2 className="text-3xl font-bold text-gray-900 mb-2">Leaderboard</h2>
                  <p className="text-gray-600">{currentEvent.meta.name}</p>
                </div>

                <div className="space-y-3 mb-8">
                  {teams.map((team, index) => {
                    const isExpanded = expandedTeams.includes(team.teamId);
                    
                    return (
                      <div key={team.teamId}>
                        <button
                          onClick={() => toggleTeamExpansion(team.teamId)}
                          className={`w-full p-5 rounded-xl ${
                            index === 0
                              ? 'bg-gradient-to-r from-yellow-400 to-yellow-500'
                              : index === 1
                              ? 'bg-gradient-to-r from-gray-300 to-gray-400'
                              : index === 2
                              ? 'bg-gradient-to-r from-orange-400 to-orange-500'
                              : 'bg-gray-50'
                          }`}
                        >
                          <div className="flex items-center justify-between">
                            <div className="flex items-center gap-4">
                              <div className={`text-2xl font-bold ${index < 3 ? 'text-white' : 'text-gray-900'}`}>
                                #{index + 1}
                              </div>
                              <div className="text-left">
                                <div className={`font-bold text-lg ${index < 3 ? 'text-white' : 'text-gray-900'}`}>
                                  {team.name}
                                </div>
                                <div className={`text-sm ${index < 3 ? 'text-white/80' : 'text-gray-600'}`}>
                                  Thru {team.stats.holesCompleted}
                                </div>
                              </div>
                            </div>
                            <div className="flex items-center gap-4">
                              <div className="text-right">
                                <div className={`text-3xl font-bold ${index < 3 ? 'text-white' : 'text-gray-900'}`}>
                                  {team.stats.total}
                                </div>
                                <div className={`text-sm font-semibold ${
                                  team.stats.toPar > 0 
                                    ? (index < 3 ? 'text-white/80' : 'text-red-600')
                                    : team.stats.toPar < 0
                                    ? (index < 3 ? 'text-white/80' : 'text-green-600')
                                    : (index < 3 ? 'text-white/80' : 'text-gray-600')
                                }`}>
                                  {team.stats.toPar > 0 ? '+' : ''}{team.stats.toPar}
                                </div>
                              </div>
                              <div className={index < 3 ? 'text-white' : 'text-gray-600'}>
                                {isExpanded ? <ChevronUp /> : <ChevronDown />}
                              </div>
                            </div>
                          </div>
                        </button>
                        
                        {isExpanded && (
                          <div className="bg-white p-4 rounded-b-xl -mt-2 border-2 border-gray-200">
                            <div className="text-xs font-semibold text-gray-600 mb-2">Hole-by-Hole</div>
                            <div className="grid grid-cols-9 gap-1">
                              {team.scores.map((score, idx) => {
                                const coursePars = currentEvent?.meta?.coursePars || [];
                                const par = coursePars[idx] || 4;
                                return (
                                  <div key={idx} className="text-center">
                                    <div className="text-xs text-gray-400">#{idx + 1}</div>
                                    <div className={`font-bold text-sm ${
                                      score === null ? 'text-gray-300' :
                                      score < par ? 'text-green-600' :
                                      score > par ? 'text-red-600' :
                                      'text-gray-900'
                                    }`}>
                                      {score || '-'}
                                    </div>
                                  </div>
                                );
                              })}
                            </div>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>

                {/* Event Code */}
                <div className="bg-gray-50 p-4 rounded-xl text-center">
                  <div className="text-xs text-gray-600 mb-2">Share this code with other groups</div>
                  <div className="flex items-center justify-center gap-3">
                    <div className="font-mono font-bold text-blue-600 text-xl">{currentEvent.meta.eventCode}</div>
                    <button
                      onClick={copyEventCode}
                      className="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700"
                    >
                      <Copy />
                    </button>
                  </div>
                  {feedback && <div className="text-sm text-green-600 mt-2">{feedback}</div>}
                </div>
              </div>
            </div>
          </div>
        );
      }

      return null;
    }

    ReactDOM.render(<LiveLinks />, document.getElementById('root'));
  </script>
</body>
</html>
